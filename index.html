import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously,
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  getDoc, 
  onSnapshot, 
  addDoc, 
  updateDoc, 
  deleteDoc,
  arrayUnion,
  arrayRemove
} from 'firebase/firestore';
import { 
  ShoppingCart, User, LogOut, Package, Plus, Trash2, 
  Store as StoreIcon, DollarSign, MessageSquare, 
  Send, Lock, Mail, Globe, Sparkles, X, Briefcase,
  Film, Image as ImageIcon, Volume2, VolumeX,
  ThumbsUp, ThumbsDown, BadgeCheck, Clock, Truck, 
  CheckCircle, MapPin, AlertCircle, Gavel, Timer, Shield
} from 'lucide-react';

// --- Firebase Configuration ---
// NOTE FOR LOCAL DEVELOPMENT (VS CODE / GITHUB):
// 1. Create a project at console.firebase.google.com
// 2. Add a Web App to get your configuration keys
// 3. Paste them into the 'localConfig' object below
const localConfig = {
  apiKey: "PASTE_YOUR_API_KEY_HERE",
  authDomain: "PASTE_YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "PASTE_YOUR_PROJECT_ID",
  storageBucket: "PASTE_YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "PASTE_YOUR_SENDER_ID",
  appId: "PASTE_YOUR_APP_ID"
};

// Logic to switch between Canvas environment and Local environment
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : localConfig;

// Initialize Firebase only if config is present
let app, auth, db;
try {
  if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE") {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
  } else {
    console.warn("Firebase not configured for local run. Please update 'localConfig' in App.jsx.");
  }
} catch (e) {
  console.error("Error initializing Firebase:", e);
}

// CONSTANT APP ID to ensure persistence across code edits within the same artifact
const appId = typeof __app_id !== 'undefined' ? __app_id : 'levstore-v2';

// --- OWNER CONSTANTS ---
const OWNER_USERNAME = 'LVS';
const OWNER_EMAIL = 'leverkusen10c@gmail.com';

// --- UI Components ---
const Button = ({ children, onClick, variant = 'primary', className = '', type = "button", disabled = false, icon: Icon }) => {
  const baseStyle = "px-4 py-2.5 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-xs sm:text-sm tracking-wide";
  const variants = {
    primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200",
    secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50",
    danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100",
    ghost: "text-gray-400 hover:text-gray-600",
    dark: "bg-gray-900 text-white hover:bg-gray-800",
    outline: "border-2 border-indigo-600 text-indigo-600 hover:bg-indigo-50",
    glass: "bg-white/20 backdrop-blur-md border border-white/30 text-white hover:bg-white/30"
  };
  return (
    <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
      {Icon && <Icon size={16} />}
      {children}
    </button>
  );
};

const Input = ({ label, type = "text", value, onChange, placeholder, required = false, icon: Icon, name, step }) => (
  <div className="mb-4">
    <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1">{label}</label>
    <div className="relative group">
      {Icon && <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-indigo-600 transition-colors"><Icon size={18} /></div>}
      <input
        name={name}
        type={type} value={value} onChange={onChange} required={required} placeholder={placeholder} step={step}
        className={`w-full bg-gray-50 border border-gray-100 text-gray-900 rounded-xl px-4 py-3.5 ${Icon ? 'pl-12' : ''} focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-600 focus:bg-white outline-none transition-all`}
      />
    </div>
  </div>
);

const Badge = ({ children, color = 'indigo' }) => {
  const colors = {
    indigo: 'bg-indigo-100 text-indigo-700',
    green: 'bg-emerald-100 text-emerald-700',
    yellow: 'bg-amber-100 text-amber-700',
    red: 'bg-red-100 text-red-700',
    blue: 'bg-blue-100 text-blue-700',
  };
  return <span className={`px-2 py-0.5 rounded-md text-[10px] font-black uppercase tracking-wider ${colors[color] || colors.indigo}`}>{children}</span>;
};

const CountDown = ({ targetDate }) => {
  const [timeLeft, setTimeLeft] = useState('');
  
  useEffect(() => {
    const interval = setInterval(() => {
      const now = new Date().getTime();
      const distance = new Date(targetDate).getTime() - now;
      
      if (distance < 0) {
        setTimeLeft('EXPIRED');
        clearInterval(interval);
      } else {
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        setTimeLeft(`${hours}h ${minutes}m ${seconds}s`);
      }
    }, 1000);
    return () => clearInterval(interval);
  }, [targetDate]);

  return <span className={`font-mono font-bold ${timeLeft === 'EXPIRED' ? 'text-red-500' : 'text-indigo-600'}`}>{timeLeft}</span>;
};

// --- Helper for Media ---
const isVideo = (url) => {
  if (!url) return false;
  return url.match(/\.(mp4|webm|ogg|mov)$/i) || url.includes('youtube') || url.includes('vimeo'); 
};

// --- Main App ---

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('auth'); 
  const [authMode, setAuthMode] = useState('login'); 
  const [products, setProducts] = useState([]);
  const [auctions, setAuctions] = useState([]); // New Auction State
  const [orders, setOrders] = useState([]);
  const [cart, setCart] = useState([]);
  const [notification, setNotification] = useState(null);
  const [activeOrderChat, setActiveOrderChat] = useState(null);
  const [activeProduct, setActiveProduct] = useState(null); 
  const [loading, setLoading] = useState(true);
  const [isFirebaseReady, setIsFirebaseReady] = useState(false);
  const [muted, setMuted] = useState(true);

  // --- 1. Init Firebase Auth ---
  useEffect(() => {
    if (!auth) {
        setNotification("Firebase not configured. Check code.");
        setLoading(false);
        return;
    }

    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Firebase connection error", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      if (u) {
        setIsFirebaseReady(true);
        const savedUsername = localStorage.getItem('levstore_username');
        if (savedUsername) restoreSession(savedUsername);
        else setLoading(false);
      }
    });
    return () => unsubscribe();
  }, []);

  // --- 2. Cloud Persistence Logic ---
  const restoreSession = async (username) => {
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', username);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        setUser({ username, ...data });
        setView('store');
        notify(`Welcome back, ${username}`);
      } else {
        localStorage.removeItem('levstore_username');
      }
    } catch (err) {
      console.error("Session restore failed", err);
    } finally {
      setLoading(false);
    }
  };

  const handleRegister = async (username, password, email, role) => {
    if (!isFirebaseReady) return notify("Connecting to cloud...");
    setLoading(true);
    
    // Prevent others from stealing LVS username
    if (username.toUpperCase() === OWNER_USERNAME && email !== OWNER_EMAIL) {
        setLoading(false);
        return notify("This reserved username requires the owner email.");
    }

    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', username);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        notify("Username already taken!");
        setLoading(false);
        return;
      }
      const userData = {
        password, email, role, 
        isAuthorized: username.toUpperCase() === OWNER_USERNAME, // Owner auto-authorized
        createdAt: new Date().toISOString(), 
        uid: auth.currentUser.uid
      };
      await setDoc(docRef, userData);
      localStorage.setItem('levstore_username', username);
      setUser({ username, ...userData });
      setView('store');
      notify("Account created & saved to cloud!");
    } catch (err) {
      console.error(err);
      notify("Registration failed.");
    } finally {
      setLoading(false);
    }
  };

  const handleLogin = async (username, password) => {
    if (!isFirebaseReady) return notify("Connecting to cloud...");
    setLoading(true);
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', username);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        if (data.password === password) {
          localStorage.setItem('levstore_username', username);
          setUser({ username, ...data });
          setView('store');
          notify("Logged in successfully");
        } else {
          notify("Incorrect password");
        }
      } else {
        notify("Account not found");
      }
    } catch (err) {
      console.error(err);
      notify("Login error. Check connection.");
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = () => {
    localStorage.removeItem('levstore_username');
    setUser(null);
    setView('auth');
    setCart([]);
  };

  // --- 3. Data Sync ---
  useEffect(() => {
    if (!user || !isFirebaseReady || !db) return;
    
    // Products Sync
    const prodRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
    const unsubProd = onSnapshot(prodRef, (snap) => {
      setProducts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });

    // Auctions Sync
    const auctRef = collection(db, 'artifacts', appId, 'public', 'data', 'auctions');
    const unsubAuct = onSnapshot(auctRef, (snap) => {
      setAuctions(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => new Date(a.endTime) - new Date(b.endTime)));
    });

    // Orders Sync
    const orderRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
    const unsubOrders = onSnapshot(orderRef, (snap) => {
      const allData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      const myOrders = allData.filter(o => o.buyerUsername === user.username || o.items.some(i => i.sellerUsername === user.username));
      setOrders(myOrders);
    });

    // Account Sync
    const myAcctRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', user.username);
    const unsubAcct = onSnapshot(myAcctRef, (snap) => {
      if(snap.exists()) setUser(prev => ({...prev, ...snap.data()}));
    });

    return () => { unsubProd(); unsubOrders(); unsubAcct(); unsubAuct(); };
  }, [user?.username, isFirebaseReady]);

  // --- Actions ---
  const notify = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };

  const addProduct = async (name, price, icon, mediaUrl) => {
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
        name, 
        price: parseFloat(price), 
        icon,
        mediaUrl: mediaUrl || '',
        sellerUsername: user.username,
        sellerAuthorized: user.isAuthorized || false,
        likes: [],
        dislikes: [],
        comments: [],
        createdAt: new Date().toISOString()
      });
      notify("Item listed on Levstore!");
    } catch (err) { notify("Error listing item."); }
  };

  const startAuction = async (name, startPrice, durationHrs, icon, mediaUrl) => {
    try {
      const endTime = new Date(Date.now() + (durationHrs * 60 * 60 * 1000)).toISOString();
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'auctions'), {
        name,
        startPrice: parseFloat(startPrice),
        currentBid: parseFloat(startPrice),
        highestBidder: null,
        endTime,
        icon,
        mediaUrl: mediaUrl || '',
        sellerUsername: user.username,
        sellerAuthorized: user.isAuthorized || false,
        bids: [],
        createdAt: new Date().toISOString()
      });
      notify("Auction started!");
    } catch (err) { notify("Error starting auction."); }
  };

  const placeBid = async (auctionId, currentBid, bidAmount) => {
    if (user.role === 'seller') return notify("Sellers cannot bid.");
    if (bidAmount <= currentBid) return notify("Bid must be higher than current price.");
    
    try {
      const ref = doc(db, 'artifacts', appId, 'public', 'data', 'auctions', auctionId);
      await updateDoc(ref, {
        currentBid: parseFloat(bidAmount),
        highestBidder: user.username,
        bids: arrayUnion({ user: user.username, amount: parseFloat(bidAmount), time: new Date().toISOString() })
      });
      notify("Bid placed successfully!");
    } catch(err) { notify("Failed to place bid."); }
  };

  const placeOrder = async () => {
    if (cart.length === 0) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
        buyerUsername: user.username,
        items: cart.map(c => ({...c, sellerUsername: c.sellerUsername})),
        total: cart.reduce((s, i) => s + (i.price * i.quantity), 0),
        status: 'placed',
        statusHistory: [{ status: 'placed', time: new Date().toISOString() }],
        messages: [],
        createdAt: new Date().toISOString()
      });
      setCart([]);
      setView('orders');
      notify("Order placed! Saved to cloud.");
    } catch (err) { notify("Checkout failed."); }
  };

  const updateOrderStatus = async (orderId, newStatus) => {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId), {
      status: newStatus,
      statusHistory: arrayUnion({ status: newStatus, time: new Date().toISOString() })
    });
    notify(`Order status updated to ${newStatus}`);
  };

  const sendMessage = async (orderId, text) => {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;
    const newMsg = { sender: user.username, text, time: new Date().toISOString() };
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId), {
      messages: [...order.messages, newMsg]
    });
  };

  const handleLike = async (productId, currentLikes) => {
    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
    if (currentLikes?.includes(user.username)) {
      await updateDoc(ref, { likes: arrayRemove(user.username) });
    } else {
      await updateDoc(ref, { likes: arrayUnion(user.username), dislikes: arrayRemove(user.username) });
    }
  };

  const handleDislike = async (productId, currentDislikes) => {
    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
    if (currentDislikes?.includes(user.username)) {
      await updateDoc(ref, { dislikes: arrayRemove(user.username) });
    } else {
      await updateDoc(ref, { dislikes: arrayUnion(user.username), likes: arrayRemove(user.username) });
    }
  };

  const postComment = async (productId, text) => {
    if (!text.trim()) return;
    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
    await updateDoc(ref, {
      comments: arrayUnion({ user: user.username, text, time: new Date().toISOString() })
    });
  };

  const deleteProduct = async (id, collectionName = 'products') => {
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id));
      notify("Item removed");
    } catch(err) { notify("Could not delete item"); }
  };

  // --- OWNER ACTION: Verify User ---
  const verifyUser = async (targetUsername) => {
    if (user.username !== OWNER_USERNAME) return notify("Access Denied: Owner Only.");
    
    try {
      const ref = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', targetUsername);
      const snap = await getDoc(ref);
      
      if (!snap.exists()) {
        return notify(`User '${targetUsername}' not found.`);
      }

      const currentStatus = snap.data().isAuthorized;
      await updateDoc(ref, { isAuthorized: !currentStatus });
      notify(`User '${targetUsername}' is now ${!currentStatus ? 'VERIFIED' : 'UNVERIFIED'}`);
    } catch(err) {
      console.error(err);
      notify("Operation failed.");
    }
  };

  // --- Views ---

  const OrderStatusStepper = ({ currentStatus }) => {
    const steps = ['placed', 'processing', 'shipped', 'delivered'];
    const currentIndex = steps.indexOf(currentStatus) === -1 ? 0 : steps.indexOf(currentStatus);
    
    return (
      <div className="flex items-center justify-between w-full mt-4 mb-2">
        {steps.map((step, idx) => {
          const completed = idx <= currentIndex;
          const icons = { placed: Clock, processing: Package, shipped: Truck, delivered: CheckCircle };
          const StepIcon = icons[step];
          return (
            <div key={step} className="flex flex-col items-center relative z-10">
              <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-300 ${completed ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-400'}`}>
                 <StepIcon size={14} />
              </div>
              <span className={`text-[10px] font-bold mt-1 uppercase tracking-wider ${completed ? 'text-indigo-600' : 'text-gray-400'}`}>{step}</span>
            </div>
          );
        })}
        <div className="absolute left-0 right-0 top-4 h-0.5 bg-gray-200 -z-0 mx-8">
           <div className="h-full bg-indigo-600 transition-all duration-500" style={{width: `${(currentIndex / (steps.length - 1)) * 100}%`}}></div>
        </div>
      </div>
    );
  };

  if (loading) return (
    <div className="min-h-screen bg-white flex items-center justify-center">
      <div className="flex flex-col items-center gap-4">
        <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
        <p className="text-indigo-600 font-bold tracking-widest animate-pulse">CONNECTING...</p>
      </div>
    </div>
  );

  // AUTH VIEW
  if (view === 'auth' || !user) {
    return (
      <div className="min-h-screen flex flex-col lg:flex-row bg-white">
        <div className="lg:w-1/2 bg-gray-900 p-12 text-white flex flex-col justify-between relative overflow-hidden">
          <div className="absolute top-0 right-0 w-full h-full opacity-20 pointer-events-none">
             <div className="absolute top-[-10%] right-[-10%] w-[60%] h-[60%] bg-indigo-500 rounded-full blur-[120px]"></div>
          </div>
          <div className="relative z-10">
            <div className="flex items-center gap-2 mb-12">
              <div className="bg-indigo-600 p-2 rounded-xl"><StoreIcon className="w-8 h-8" /></div>
              <div>
                <span className="text-2xl font-black tracking-tighter">LEV<span className="text-indigo-400">STORE</span></span>
                <span className="block text-[10px] font-mono text-gray-400">MADE BY LSV</span>
              </div>
            </div>
            <h1 className="text-5xl font-extrabold leading-tight mb-6">{authMode === 'login' ? 'Welcome Back.' : 'Join the Future.'}</h1>
            <p className="text-gray-400 text-lg max-w-md">Secure, cloud-based marketplace. Persistent accounts for every version.</p>
          </div>
        </div>
        <div className="lg:w-1/2 p-8 lg:p-24 flex flex-col justify-center">
          <div className="max-w-md w-full mx-auto">
            <h2 className="text-3xl font-bold mb-2 text-slate-900">{authMode === 'login' ? 'Sign In' : 'Create Account'}</h2>
            <form onSubmit={(e) => {
              e.preventDefault();
              const fd = new FormData(e.target);
              if (authMode === 'login') handleLogin(fd.get('username'), fd.get('password'));
              else handleRegister(fd.get('username'), fd.get('password'), fd.get('email'), fd.get('role'));
            }}>
              <Input label="Username" name="username" placeholder="johndoe" icon={User} required />
              {authMode === 'register' && (
                <>
                  <Input label="Email" name="email" type="email" placeholder="you@example.com" icon={Mail} required />
                  <div className="mb-6">
                    <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Account Type</label>
                    <div className="grid grid-cols-2 gap-4">
                      <label className="cursor-pointer">
                        <input type="radio" name="role" value="buyer" defaultChecked className="hidden peer" />
                        <div className="p-4 border-2 rounded-xl text-center peer-checked:border-indigo-600 peer-checked:bg-indigo-50 font-bold text-gray-500 peer-checked:text-indigo-600 transition-all">Buyer</div>
                      </label>
                      <label className="cursor-pointer">
                        <input type="radio" name="role" value="seller" className="hidden peer" />
                        <div className="p-4 border-2 rounded-xl text-center peer-checked:border-indigo-600 peer-checked:bg-indigo-50 font-bold text-gray-500 peer-checked:text-indigo-600 transition-all">Seller</div>
                      </label>
                    </div>
                  </div>
                </>
              )}
              <Input label="Password" name="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" icon={Lock} required />
              <Button type="submit" className="w-full py-4 mt-4" disabled={loading}>{loading ? 'Processing...' : (authMode === 'login' ? 'Sign In' : 'Create Account')}</Button>
            </form>
            <div className="mt-8 text-center text-sm text-gray-500">
              <button onClick={() => setAuthMode(authMode === 'login' ? 'register' : 'login')} className="font-bold text-indigo-600 hover:underline">{authMode === 'login' ? 'Create Account' : 'Log In'}</button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // MAIN VIEW
  return (
    <div className="min-h-screen bg-[#FDFDFD] text-slate-900 pb-20">
      {notification && (
        <div className="fixed top-24 right-6 z-[100] bg-gray-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 animate-bounce">
          <Sparkles className="text-yellow-400" size={20} />
          <span className="font-bold">{notification}</span>
        </div>
      )}

      {/* Nav */}
      <nav className="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-gray-100 supports-[backdrop-filter]:bg-white/60">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 h-20 flex justify-between items-center">
          <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('store')}>
            <div className="bg-indigo-600 p-1.5 rounded-lg shadow-lg shadow-indigo-100"><StoreIcon className="w-6 h-6 text-white" /></div>
            <div>
               <span className="font-black text-xl sm:text-2xl tracking-tighter leading-none">LEV<span className="text-indigo-600">STORE</span></span>
               <span className="block text-[8px] sm:text-[10px] font-mono text-gray-400 leading-none">MADE BY LSV</span>
            </div>
          </div>
          <div className="flex items-center gap-4 sm:gap-6 overflow-x-auto no-scrollbar pl-2">
            <button onClick={() => setView('store')} className={`text-xs sm:text-sm font-bold tracking-widest uppercase whitespace-nowrap ${view === 'store' ? 'text-indigo-600' : 'text-gray-400 hover:text-gray-600'}`}>Market</button>
            <button onClick={() => setView('auctions')} className={`text-xs sm:text-sm font-bold tracking-widest uppercase whitespace-nowrap flex items-center gap-1 ${view === 'auctions' ? 'text-indigo-600' : 'text-gray-400 hover:text-gray-600'}`}><Gavel size={14}/> Auctions</button>
            <button onClick={() => setView('reels')} className={`text-xs sm:text-sm font-bold tracking-widest uppercase whitespace-nowrap flex items-center gap-1 ${view === 'reels' ? 'text-indigo-600' : 'text-gray-400 hover:text-gray-600'}`}><Film size={14}/> Reels</button>
            {user?.role === 'seller' && <button onClick={() => setView('dashboard')} className={`text-xs sm:text-sm font-bold tracking-widest uppercase whitespace-nowrap ${view === 'dashboard' ? 'text-indigo-600' : 'text-gray-400 hover:text-gray-600'}`}>Sell</button>}
            <button onClick={() => setView('orders')} className={`text-xs sm:text-sm font-bold tracking-widest uppercase whitespace-nowrap ${view === 'orders' ? 'text-indigo-600' : 'text-gray-400 hover:text-gray-600'}`}>Orders</button>
            
            <div className="h-8 w-px bg-gray-200 hidden sm:block"></div>

            <button onClick={() => setView('cart')} className="relative p-2 text-gray-600 hover:bg-gray-50 rounded-full transition-all">
              <ShoppingCart size={22} />
              {cart.length > 0 && <span className="absolute top-0 right-0 w-5 h-5 bg-indigo-600 text-[10px] text-white flex items-center justify-center rounded-full font-bold ring-4 ring-white">{cart.length}</span>}
            </button>

            <div className="flex items-center gap-3 group cursor-pointer" onClick={handleLogout} title="Log Out / Switch Account">
              <div className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center font-bold uppercase border-2 border-transparent group-hover:border-indigo-100">{user?.username?.[0]}</div>
            </div>
          </div>
        </div>
      </nav>

      {/* Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-12">
        {view === 'store' && (
          <div className="space-y-12 animate-in fade-in duration-500">
            {/* Hero */}
            <div className="bg-indigo-600 rounded-[2.5rem] p-8 sm:p-12 text-white relative overflow-hidden shadow-2xl shadow-indigo-200 min-h-[300px] flex items-center">
               <div className="relative z-10 max-w-xl">
                 <h2 className="text-4xl sm:text-5xl font-black mb-4 leading-tight">Levstore Global Market</h2>
                 <p className="text-indigo-100 text-lg mb-8 opacity-80">Real-time cloud inventory. Explore Reels or check the Auction House.</p>
                 <div className="flex gap-4">
                    <Button onClick={() => setView('reels')} variant="glass" className="backdrop-blur-xl bg-white/10" icon={Film}>Watch Reels</Button>
                    <Button onClick={() => setView('auctions')} variant="glass" className="backdrop-blur-xl bg-white/10" icon={Gavel}>Bid Now</Button>
                 </div>
               </div>
               <div className="absolute right-[-10%] top-[-20%] w-[50%] h-[150%] bg-white/5 rotate-12 blur-3xl"></div>
            </div>

            {/* Grid */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 sm:gap-8">
              {products.map(p => (
                <div key={p.id} onClick={() => setActiveProduct(p)} className="bg-white group cursor-pointer rounded-[2rem] p-4 border border-gray-100 hover:shadow-2xl transition-all duration-500 flex flex-col h-full relative">
                  <div className="aspect-square bg-slate-50 rounded-[1.5rem] overflow-hidden mb-4 relative group-hover:bg-indigo-50 transition-colors">
                    {p.mediaUrl ? (
                        isVideo(p.mediaUrl) ? <video src={p.mediaUrl} className="w-full h-full object-cover" muted loop onMouseOver={e => e.target.play()} onMouseOut={e => e.target.pause()} /> 
                        : <img src={p.mediaUrl} alt={p.name} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center text-7xl"><span className="group-hover:scale-110 transition-transform duration-500">{p.icon}</span></div>
                    )}
                    <div className="absolute bottom-3 right-3 flex gap-2">
                       <div className="bg-white/80 backdrop-blur px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1"><ThumbsUp size={12} className={p.likes?.includes(user.username) ? 'text-indigo-600' : ''} /> {p.likes?.length || 0}</div>
                    </div>
                  </div>
                  <div className="px-2 flex flex-col flex-1">
                    <div className="flex justify-between items-start mb-2">
                      <h3 className="font-black text-xl text-slate-900 truncate flex-1 pr-2">{p.name}</h3>
                      <span className="font-bold text-indigo-600">${p.price}</span>
                    </div>
                    <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-6 flex items-center gap-1">
                      <User size={12}/> {p.sellerUsername} {p.sellerAuthorized && <BadgeCheck size={14} className="text-blue-500 fill-blue-100" />}
                    </p>
                    {user.role === 'buyer' ? (
                        <Button 
                            onClick={(e) => {
                                e.stopPropagation();
                                setCart(prev => {
                                const ex = prev.find(i => i.id === p.id);
                                return ex ? prev.map(i => i.id === p.id ? {...i, quantity: i.quantity+1} : i) : [...prev, {...p, quantity: 1}];
                                });
                                notify(`Added ${p.name} to cart`);
                            }}
                            className="w-full rounded-2xl py-3.5 mt-auto" variant="dark"
                        >
                            Add to Cart
                        </Button>
                    ) : (
                        <Button disabled className="w-full rounded-2xl py-3.5 mt-auto bg-gray-100 text-gray-400 shadow-none cursor-not-allowed">
                            Seller Account
                        </Button>
                    )}
                  </div>
                </div>
              ))}
            </div>
            {products.length === 0 && <p className="text-center text-gray-400 font-bold py-10">Market Empty</p>}
          </div>
        )}

        {view === 'auctions' && (
          <div className="space-y-8 animate-in fade-in duration-500">
             <div className="text-center max-w-2xl mx-auto mb-12">
               <div className="bg-indigo-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-600"><Gavel size={32}/></div>
               <h2 className="text-4xl font-black mb-4">Auction House</h2>
               <p className="text-gray-400">Bid on exclusive items in real-time. Highest bidder wins when the timer runs out.</p>
             </div>

             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
               {auctions.map(a => {
                  const isEnded = new Date(a.endTime) < new Date();
                  return (
                    <div key={a.id} className="bg-white rounded-[2rem] border border-gray-100 overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300">
                       <div className="h-48 bg-slate-50 relative">
                          {a.mediaUrl ? (isVideo(a.mediaUrl) ? <video src={a.mediaUrl} className="w-full h-full object-cover"/> : <img src={a.mediaUrl} className="w-full h-full object-cover"/>) : <div className="w-full h-full flex items-center justify-center text-6xl">{a.icon}</div>}
                          <div className="absolute top-4 right-4 bg-black/70 backdrop-blur text-white px-3 py-1 rounded-full text-xs font-mono font-bold flex items-center gap-2">
                             <Timer size={12}/> <CountDown targetDate={a.endTime} />
                          </div>
                       </div>
                       <div className="p-6">
                          <h3 className="text-xl font-black mb-1">{a.name}</h3>
                          <p className="text-xs text-gray-400 font-bold uppercase tracking-widest mb-4">Seller: {a.sellerUsername}</p>
                          
                          <div className="bg-indigo-50 rounded-xl p-4 mb-6 flex justify-between items-end">
                             <div>
                               <p className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1">Current Bid</p>
                               <p className="text-3xl font-black text-indigo-600">${a.currentBid}</p>
                             </div>
                             <div className="text-right">
                               <p className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1">Highest Bidder</p>
                               <p className="text-sm font-bold">{a.highestBidder || 'None'}</p>
                             </div>
                          </div>

                          {!isEnded ? (
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                placeBid(a.id, a.currentBid, e.target.bid.value);
                                e.target.reset();
                            }} className="flex gap-2">
                                <input name="bid" type="number" step="1" min={a.currentBid + 1} placeholder={`Min $${a.currentBid + 1}`} className="flex-1 bg-gray-100 rounded-xl px-4 font-bold outline-none focus:ring-2 focus:ring-indigo-500/20" required />
                                <Button type="submit" variant="dark" disabled={user.role === 'seller'}>Bid</Button>
                            </form>
                          ) : (
                            <div className="bg-red-50 text-red-600 font-bold text-center py-3 rounded-xl uppercase tracking-widest text-xs">Auction Ended</div>
                          )}
                          {user.role === 'seller' && <p className="text-[10px] text-center text-gray-400 mt-2">Sellers cannot bid</p>}
                       </div>
                    </div>
                  );
               })}
             </div>
             {auctions.length === 0 && <p className="text-center text-gray-400 font-bold py-10">No active auctions.</p>}
          </div>
        )}

        {view === 'reels' && (
          <div className="max-w-md mx-auto h-[80vh] bg-black rounded-[2rem] overflow-hidden shadow-2xl relative animate-in fade-in">
             <div className="absolute top-4 right-4 z-20">
                <button onClick={() => setMuted(!muted)} className="bg-black/50 p-2 rounded-full text-white backdrop-blur-md">
                   {muted ? <VolumeX size={20}/> : <Volume2 size={20}/>}
                </button>
             </div>
             <div className="snap-y snap-mandatory h-full overflow-y-scroll no-scrollbar scroll-smooth">
                {products.map(p => (
                   <div key={p.id} className="snap-center h-full w-full relative flex items-center justify-center bg-gray-900">
                      {p.mediaUrl ? (
                         isVideo(p.mediaUrl) ? (
                            <video src={p.mediaUrl} className="w-full h-full object-cover" autoPlay muted={muted} loop playsInline />
                         ) : <img src={p.mediaUrl} alt={p.name} className="w-full h-full object-cover" />
                      ) : <div className="text-9xl animate-bounce">{p.icon}</div>}
                      
                      <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent pointer-events-none"></div>
                      <div className="absolute bottom-0 left-0 right-0 p-8 pb-12 text-white">
                         <div className="flex items-end justify-between">
                            <div>
                               <div className="flex items-center gap-2 mb-2">
                                  <div className="bg-indigo-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs">{p.sellerUsername[0]}</div>
                                  <span className="font-bold text-sm text-indigo-200">@{p.sellerUsername}</span>
                                  {p.sellerAuthorized && <BadgeCheck size={16} className="text-blue-400"/>}
                               </div>
                               <h2 className="text-3xl font-black mb-1">{p.name}</h2>
                               <p className="text-2xl font-bold text-green-400">${p.price}</p>
                            </div>
                            <div className="flex flex-col gap-4 pointer-events-auto">
                               <button onClick={() => setActiveProduct(p)} className="bg-white/10 backdrop-blur p-3 rounded-full hover:bg-white/20"><MessageSquare size={24} text-white/></button>
                               {user.role === 'buyer' && (
                                <button onClick={() => {
                                    setCart(prev => {
                                        const ex = prev.find(i => i.id === p.id);
                                        return ex ? prev.map(i => i.id === p.id ? {...i, quantity: i.quantity+1} : i) : [...prev, {...p, quantity: 1}];
                                    });
                                    notify("Added to Cart!");
                                }} className="bg-white text-black p-4 rounded-full shadow-lg active:scale-90 transition-transform">
                                    <Plus size={24}/>
                                </button>
                               )}
                            </div>
                         </div>
                      </div>
                   </div>
                ))}
             </div>
          </div>
        )}

        {view === 'dashboard' && user.role === 'seller' && (
          <div className="grid lg:grid-cols-12 gap-8 lg:gap-12 animate-in fade-in duration-500">
             <div className="lg:col-span-4 space-y-8">
               <div className="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm text-center">
                  <div className="w-20 h-20 bg-indigo-50 rounded-full mx-auto flex items-center justify-center text-3xl mb-4">{user.username[0]}</div>
                  <h3 className="font-black text-xl flex items-center justify-center gap-2">
                    {user.username} {user.isAuthorized && <BadgeCheck size={20} className="text-blue-500 fill-blue-100"/>}
                  </h3>
                  <p className="text-gray-400 text-sm mb-4">Seller Account</p>
                  
                  {/* OWNER ONLY PANEL */}
                  {user.username === OWNER_USERNAME && (
                     <div className="mt-4 pt-4 border-t border-gray-100 text-left">
                        <h4 className="font-black text-indigo-600 flex items-center gap-2 mb-2"><Shield size={16}/> Owner Panel</h4>
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            verifyUser(e.target.targetUser.value);
                            e.target.reset();
                        }}>
                           <Input name="targetUser" placeholder="Username to Verify" className="text-xs" />
                           <Button type="submit" variant="dark" className="w-full text-xs">Toggle Authorization</Button>
                        </form>
                     </div>
                  )}
               </div>

               {/* Add Product Form */}
               <div className="bg-white p-6 sm:p-8 rounded-[2rem] border border-gray-100 shadow-sm">
                 <h3 className="text-xl font-black mb-6 flex items-center gap-2"><Plus className="text-indigo-600"/> List New Item</h3>
                 <form onSubmit={(e) => {
                   e.preventDefault();
                   const fd = new FormData(e.target);
                   addProduct(fd.get('name'), fd.get('price'), fd.get('icon'), fd.get('mediaUrl'));
                   e.target.reset();
                 }}>
                   <Input label="Item Icon" name="icon" placeholder="ðŸŽ" required />
                   <Input label="Item Name" name="name" placeholder="Pro Gadget" required />
                   <Input label="Price ($)" name="price" type="number" placeholder="49.99" icon={DollarSign} required />
                   <Input label="Photo/Video URL" name="mediaUrl" placeholder="https://..." icon={ImageIcon} />
                   <Button type="submit" className="w-full py-4 mt-2 shadow-none" variant="dark">Post to Cloud</Button>
                 </form>
               </div>

               {/* Add Auction Form */}
               <div className="bg-white p-6 sm:p-8 rounded-[2rem] border border-gray-100 shadow-sm">
                 <h3 className="text-xl font-black mb-6 flex items-center gap-2"><Gavel className="text-indigo-600"/> Start Auction</h3>
                 <form onSubmit={(e) => {
                   e.preventDefault();
                   const fd = new FormData(e.target);
                   startAuction(fd.get('name'), fd.get('price'), fd.get('duration'), fd.get('icon'), fd.get('mediaUrl'));
                   e.target.reset();
                 }}>
                   <Input label="Auction Item Name" name="name" placeholder="Rare Item" required />
                   <Input label="Start Price ($)" name="price" type="number" placeholder="10.00" icon={DollarSign} required />
                   <Input label="Duration (Hours)" name="duration" type="number" placeholder="24" icon={Clock} required />
                   <Input label="Icon" name="icon" placeholder="ðŸ’Ž" required />
                   <Input label="Photo/Video URL" name="mediaUrl" placeholder="https://..." icon={ImageIcon} />
                   <Button type="submit" className="w-full py-4 mt-2 shadow-none" variant="primary">Launch Auction</Button>
                 </form>
               </div>
             </div>
             
             <div className="lg:col-span-8 space-y-8">
               <h2 className="text-2xl font-black">Manage Orders</h2>
               {orders.filter(o => o.items.some(i => i.sellerUsername === user.username)).map(order => (
                  <div key={order.id} className="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
                      <div className="flex justify-between items-start mb-4">
                         <div>
                            <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Order #{order.id.slice(-6)}</span>
                            <div className="flex items-center gap-2 mt-1">
                                <span className={`w-2 h-2 rounded-full ${order.status === 'delivered' ? 'bg-green-500' : 'bg-yellow-500'}`}></span>
                                <span className="font-bold text-sm uppercase">{order.status}</span>
                            </div>
                         </div>
                         <div className="flex gap-2">
                            {['processing', 'shipped', 'delivered'].map(s => (
                                <button 
                                    key={s}
                                    onClick={() => updateOrderStatus(order.id, s)}
                                    className={`px-3 py-1 rounded-lg text-xs font-bold capitalize transition-colors ${order.status === s ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                                >
                                    {s}
                                </button>
                            ))}
                         </div>
                      </div>
                      <div className="space-y-2">
                          {order.items.filter(i => i.sellerUsername === user.username).map((item, idx) => (
                              <div key={idx} className="flex items-center justify-between text-sm">
                                  <span className="flex items-center gap-2">{item.icon} {item.name} <span className="text-gray-400">x{item.quantity}</span></span>
                                  <span className="font-mono">${item.price}</span>
                              </div>
                          ))}
                      </div>
                  </div>
               ))}
               
               <h2 className="text-2xl font-black mt-12">Your Active Auctions</h2>
               <div className="grid gap-4">
                  {auctions.filter(a => a.sellerUsername === user.username).map(a => (
                      <div key={a.id} className="bg-white p-4 rounded-2xl border border-gray-100 flex items-center gap-4">
                          <div className="w-16 h-16 bg-indigo-50 rounded-xl flex items-center justify-center text-2xl">{a.icon}</div>
                          <div className="flex-1">
                              <h4 className="font-bold">{a.name}</h4>
                              <p className="text-sm text-gray-500">Current Bid: <span className="text-indigo-600 font-bold">${a.currentBid}</span></p>
                              <p className="text-xs text-gray-400">Ends in: <CountDown targetDate={a.endTime}/></p>
                          </div>
                          <button onClick={() => deleteProduct(a.id, 'auctions')} className="p-2 text-red-400 hover:bg-red-50 rounded-lg"><Trash2 size={18}/></button>
                      </div>
                  ))}
               </div>

               <h2 className="text-2xl font-black mt-12">Your Inventory</h2>
               <div className="grid gap-4">
                 {products.filter(p => p.sellerUsername === user.username).map(p => (
                   <div key={p.id} className="bg-white p-4 rounded-2xl border border-gray-100 flex items-center gap-4 sm:gap-6 group">
                     <div className="w-16 h-16 bg-gray-50 rounded-2xl overflow-hidden flex-shrink-0 flex items-center justify-center">
                        {p.mediaUrl ? <img src={p.mediaUrl} className="w-full h-full object-cover"/> : <span className="text-3xl">{p.icon}</span>}
                     </div>
                     <div className="flex-1 min-w-0">
                       <h4 className="font-bold text-lg truncate">{p.name}</h4>
                       <p className="text-indigo-600 font-bold">${p.price}</p>
                       <div className="flex gap-4 mt-1 text-xs text-gray-400">
                          <span className="flex items-center gap-1"><ThumbsUp size={10}/> {p.likes?.length || 0}</span>
                          <span className="flex items-center gap-1"><MessageSquare size={10}/> {p.comments?.length || 0}</span>
                       </div>
                     </div>
                     <button onClick={() => deleteProduct(p.id)} className="p-3 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><Trash2 size={20}/></button>
                   </div>
                 ))}
               </div>
             </div>
          </div>
        )}

        {view === 'orders' && (
          <div className="max-w-3xl mx-auto space-y-6 animate-in fade-in duration-500">
            <h2 className="text-3xl font-black mb-8">Order History</h2>
            {orders.map(order => (
              <div key={order.id} className="bg-white rounded-[2rem] border border-gray-100 overflow-hidden shadow-sm">
                <div className="p-6 bg-slate-50 flex justify-between items-center border-b border-gray-100">
                   <div>
                     <p className="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-1">Order ID</p>
                     <p className="font-mono text-xs text-indigo-600">#{order.id.slice(-8)}</p>
                   </div>
                   <div className="text-right">
                     <p className="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-1">Total Paid</p>
                     <p className="font-black text-xl">${order.total.toFixed(2)}</p>
                   </div>
                </div>
                <div className="p-6 relative">
                  {/* Status Timeline */}
                  <div className="mb-8">
                     <p className="text-xs font-bold text-gray-500 mb-2 uppercase">Status: <span className="text-indigo-600">{order.status}</span></p>
                     <OrderStatusStepper currentStatus={order.status} />
                  </div>

                  <div className="space-y-4">
                    {order.items.map((it, idx) => (
                        <div key={idx} className="flex justify-between items-center text-sm font-bold">
                        <div className="flex items-center gap-3"><span className="text-xl">{it.icon}</span> {it.name} <span className="text-gray-300">x{it.quantity}</span></div>
                        <span>${(it.price * it.quantity).toFixed(2)}</span>
                        </div>
                    ))}
                  </div>
                  <div className="pt-6 mt-4 border-t border-gray-100 flex justify-between items-center">
                    <span className="text-xs font-bold text-emerald-500 flex items-center gap-1"><Globe size={12}/> Cloud Verified</span>
                    <Button variant="secondary" onClick={() => setActiveOrderChat(order)} className="!py-2 !px-4 text-xs shadow-none">
                      <MessageSquare size={14}/> {order.messages.length} Messages
                    </Button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        {view === 'cart' && (
            // Only buyers can see cart content effectively
           <div className="max-w-5xl mx-auto grid lg:grid-cols-3 gap-12 animate-in fade-in duration-500">
             <div className="lg:col-span-2 space-y-6">
                <h2 className="text-3xl font-black mb-8">Your Cart</h2>
                {cart.map(item => (
                  <div key={item.id} className="bg-white p-6 rounded-[2rem] border border-gray-100 flex items-center gap-6">
                    <div className="w-20 h-20 bg-indigo-50 flex-shrink-0 flex items-center justify-center rounded-[1.5rem] overflow-hidden">
                       {item.mediaUrl ? <img src={item.mediaUrl} className="w-full h-full object-cover"/> : <span className="text-4xl">{item.icon}</span>}
                    </div>
                    <div className="flex-1 min-w-0">
                      <h4 className="font-bold text-xl truncate">{item.name}</h4>
                      <p className="text-gray-400 font-bold tracking-tight">${item.price} per unit</p>
                    </div>
                    <div className="flex items-center gap-4 bg-gray-50 p-2 rounded-xl">
                       <button onClick={() => setCart(cart.map(i => i.id === item.id ? {...i, quantity: Math.max(1, i.quantity-1)} : i))} className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-lg transition-colors font-bold text-gray-400">-</button>
                       <span className="font-black w-4 text-center">{item.quantity}</span>
                       <button onClick={() => setCart(cart.map(i => i.id === item.id ? {...i, quantity: i.quantity+1} : i))} className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-lg transition-colors font-bold text-gray-400">+</button>
                    </div>
                  </div>
                ))}
                {cart.length === 0 && <div className="text-center py-20 bg-slate-50 rounded-[2rem] border-2 border-dashed border-gray-100 text-gray-400 font-bold">Your cart is empty</div>}
             </div>
             <div className="lg:col-span-1">
                <div className="bg-white p-8 rounded-[2rem] border border-indigo-100 shadow-xl shadow-indigo-100/20 sticky top-24">
                   <h3 className="text-xl font-black mb-6">Summary</h3>
                   <div className="space-y-4 mb-8">
                      <div className="flex justify-between text-gray-400 font-bold"><span>Subtotal</span><span>${cart.reduce((s,i)=>s+(i.price*i.quantity),0).toFixed(2)}</span></div>
                      <div className="flex justify-between text-slate-900 font-black text-2xl"><span>Total</span><span>${cart.reduce((s,i)=>s+(i.price*i.quantity),0).toFixed(2)}</span></div>
                   </div>
                   <Button onClick={placeOrder} className="w-full py-4 text-lg" disabled={cart.length === 0}>Complete Purchase</Button>
                   <p className="text-[10px] text-gray-400 text-center mt-4 font-bold uppercase tracking-widest">Secured by Levstore Cloud</p>
                </div>
             </div>
           </div>
        )}
      </main>

      {/* Product Details & Comments Modal */}
      {activeProduct && (
        <div className="fixed inset-0 bg-gray-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[80vh] animate-in zoom-in-95 duration-200">
                <div className="p-6 bg-white border-b border-gray-100 flex justify-between items-center sticky top-0 z-10">
                    <h3 className="font-black text-xl">{activeProduct.name}</h3>
                    <button onClick={() => setActiveProduct(null)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><X size={20}/></button>
                </div>
                <div className="flex-1 overflow-y-auto p-6">
                    <div className="flex gap-4 mb-6">
                        <div className="w-24 h-24 bg-gray-50 rounded-2xl flex items-center justify-center overflow-hidden flex-shrink-0">
                            {activeProduct.mediaUrl ? (isVideo(activeProduct.mediaUrl) ? <video src={activeProduct.mediaUrl} className="w-full h-full object-cover"/> : <img src={activeProduct.mediaUrl} className="w-full h-full object-cover"/>) : <span className="text-4xl">{activeProduct.icon}</span>}
                        </div>
                        <div>
                            <p className="text-2xl font-black text-indigo-600">${activeProduct.price}</p>
                            <p className="text-sm font-bold text-gray-500">Seller: @{activeProduct.sellerUsername}</p>
                            <div className="flex gap-4 mt-2">
                                <button onClick={() => handleLike(activeProduct.id, activeProduct.likes)} className={`flex items-center gap-1 font-bold ${activeProduct.likes?.includes(user.username) ? 'text-green-600' : 'text-gray-400'}`}><ThumbsUp size={16}/> {activeProduct.likes?.length || 0}</button>
                                <button onClick={() => handleDislike(activeProduct.id, activeProduct.dislikes)} className={`flex items-center gap-1 font-bold ${activeProduct.dislikes?.includes(user.username) ? 'text-red-600' : 'text-gray-400'}`}><ThumbsDown size={16}/> {activeProduct.dislikes?.length || 0}</button>
                            </div>
                        </div>
                    </div>
                    
                    <h4 className="font-bold text-lg mb-4">Comments</h4>
                    <div className="space-y-4 mb-6">
                        {activeProduct.comments?.length === 0 && <p className="text-gray-400 text-sm">No comments yet. Be the first!</p>}
                        {activeProduct.comments?.map((c, i) => (
                            <div key={i} className="bg-gray-50 p-4 rounded-2xl">
                                <p className="text-xs font-bold text-gray-400 mb-1">@{c.user}</p>
                                <p className="text-sm text-gray-800">{c.text}</p>
                            </div>
                        ))}
                    </div>
                    
                    <form onSubmit={(e) => {
                        e.preventDefault();
                        const val = e.target.comment.value;
                        postComment(activeProduct.id, val);
                        e.target.comment.value = '';
                    }} className="flex gap-2">
                        <input name="comment" className="flex-1 bg-gray-100 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500/20" placeholder="Add a comment..." />
                        <Button type="submit" variant="dark">Post</Button>
                    </form>
                </div>
            </div>
        </div>
      )}

      {/* Chat Overlay */}
      {activeOrderChat && (
        <div className="fixed inset-0 bg-gray-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-4">
           <div className="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col h-[650px] animate-in zoom-in-95 duration-200">
              <div className="p-6 bg-indigo-600 text-white flex justify-between items-center">
                 <div>
                   <h4 className="font-black text-lg">Transaction Chat</h4>
                   <p className="text-xs text-indigo-200 font-bold tracking-widest uppercase">Order #{activeOrderChat.id.slice(-6)}</p>
                 </div>
                 <button onClick={() => setActiveOrderChat(null)} className="p-3 bg-white/10 rounded-2xl hover:bg-white/20 transition-all"><X/></button>
              </div>
              <div className="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50">
                 {activeOrderChat.messages.map((m, i) => (
                   <div key={i} className={`flex flex-col ${m.sender === user.username ? 'items-end' : 'items-start'}`}>
                      <div className={`max-w-[85%] p-4 rounded-2xl font-medium text-sm shadow-sm ${m.sender === user.username ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-slate-900 rounded-tl-none'}`}>
                        {m.text}
                      </div>
                      <span className="text-[10px] font-bold text-gray-400 mt-1 uppercase tracking-tighter">{m.sender}</span>
                   </div>
                 ))}
              </div>
              <form className="p-4 bg-white border-t border-gray-100 flex gap-3" onSubmit={(e) => {
                e.preventDefault();
                const msg = e.target.msg.value;
                if(!msg.trim()) return;
                sendMessage(activeOrderChat.id, msg);
                e.target.msg.value = '';
              }}>
                <input name="msg" className="flex-1 bg-gray-100 rounded-2xl px-6 py-3.5 focus:ring-4 focus:ring-indigo-500/10 outline-none font-medium transition-all" placeholder="Message..." />
                <Button type="submit" variant="dark" className="!p-3.5 rounded-2xl"><Send size={20}/></Button>
              </form>
           </div>
        </div>
      )}
    </div>
  );
}
