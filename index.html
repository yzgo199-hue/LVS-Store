import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously,
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  getDoc, 
  onSnapshot, 
  addDoc, 
  updateDoc, 
  deleteDoc,
  arrayUnion,
  arrayRemove
} from 'firebase/firestore';
import { 
  ShoppingCart, User, LogOut, Package, Plus, Trash2, 
  Store as StoreIcon, DollarSign, MessageSquare, 
  Send, Lock, Mail, Globe, Sparkles, X, Briefcase,
  Film, Image as ImageIcon, Volume2, VolumeX,
  ThumbsUp, ThumbsDown, BadgeCheck, Clock, Truck, 
  CheckCircle, MapPin, AlertCircle, Gavel, Timer, 
  Shield, Search, Filter, Heart, Share2, Info
} from 'lucide-react';

/**
 * ==================================================================================
 * LVS-STORE CONFIGURATION (GITHUB / VS CODE)
 * ==================================================================================
 * INSTRUCTIONS:
 * 1. Go to https://console.firebase.google.com/
 * 2. Create a new project or select your existing one.
 * 3. Register a "Web App" (</> icon).
 * 4. Copy the `firebaseConfig` object keys and paste them below into `githubConfig`.
 * 5. Enable "Authentication" (Anonymous & Email/Password).
 * 6. Enable "Firestore Database" (Start in Test Mode).
 * ==================================================================================
 */
const githubConfig = {
  apiKey: "PASTE_YOUR_API_KEY_HERE",
  authDomain: "PASTE_YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "PASTE_YOUR_PROJECT_ID",
  storageBucket: "PASTE_YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "PASTE_YOUR_SENDER_ID",
  appId: "PASTE_YOUR_APP_ID"
};

// --- Environment Detection & Firebase Initialization ---
// This logic allows the code to work both in the online editor AND on GitHub/Localhost
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : githubConfig;

let app, auth, db;
try {
  // Only initialize if we have a valid key (or if using the online environment)
  if (firebaseConfig && (firebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE" || typeof __firebase_config !== 'undefined')) {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    console.log("Levstore Cloud: Connected");
  } else {
    console.warn("Levstore Warning: Firebase keys not set in 'githubConfig'. App will stick in loading state locally.");
  }
} catch (e) {
  console.error("Levstore Error: Failed to initialize Firebase.", e);
}

// --- App Constants ---
const APP_VERSION = "2.4.0"; // Incrementing ensures we track updates
const appId = typeof __app_id !== 'undefined' ? __app_id : 'levstore-v2-production';
const OWNER_USERNAME = 'LVS';
const OWNER_EMAIL = 'leverkusen10c@gmail.com';

/**
 * ==================================================================================
 * UI COMPONENT LIBRARY
 * Reusable, consistent components for the Levstore Design System
 * ==================================================================================
 */

const Button = ({ 
  children, 
  onClick, 
  variant = 'primary', 
  className = '', 
  type = "button", 
  disabled = false, 
  icon: Icon 
}) => {
  const baseStyle = "px-5 py-3 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-sm tracking-wide shadow-sm";
  
  const variants = {
    primary: "bg-indigo-600 text-white hover:bg-indigo-700 hover:shadow-indigo-200 hover:shadow-lg border border-transparent",
    secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:border-gray-300",
    danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100",
    ghost: "bg-transparent text-gray-400 hover:text-gray-900 hover:bg-gray-100 border-transparent shadow-none",
    dark: "bg-gray-900 text-white hover:bg-black hover:shadow-xl border border-transparent",
    outline: "bg-transparent border-2 border-indigo-600 text-indigo-600 hover:bg-indigo-50",
    glass: "bg-white/20 backdrop-blur-md border border-white/30 text-white hover:bg-white/30 shadow-none"
  };

  return (
    <button 
      type={type} 
      onClick={onClick} 
      disabled={disabled} 
      className={`${baseStyle} ${variants[variant]} ${className}`}
    >
      {Icon && <Icon size={18} strokeWidth={2.5} />}
      {children}
    </button>
  );
};

const Input = ({ 
  label, 
  type = "text", 
  value, 
  onChange, 
  placeholder, 
  required = false, 
  icon: Icon, 
  name, 
  step 
}) => (
  <div className="mb-5 w-full">
    {label && (
      <label className="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2 ml-1">
        {label} {required && <span className="text-red-400">*</span>}
      </label>
    )}
    <div className="relative group">
      {Icon && (
        <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-indigo-600 transition-colors duration-300">
          <Icon size={18} />
        </div>
      )}
      <input
        name={name}
        type={type} 
        value={value} 
        onChange={onChange} 
        required={required} 
        placeholder={placeholder} 
        step={step}
        className={`w-full bg-gray-50 border-2 border-gray-100 text-gray-900 rounded-xl px-4 py-3.5 ${Icon ? 'pl-12' : ''} focus:ring-0 focus:border-indigo-600 focus:bg-white outline-none transition-all duration-300 font-medium placeholder-gray-300`}
      />
    </div>
  </div>
);

const Badge = ({ children, color = 'indigo', className = '' }) => {
  const colors = {
    indigo: 'bg-indigo-100 text-indigo-700 border-indigo-200',
    green: 'bg-emerald-100 text-emerald-700 border-emerald-200',
    yellow: 'bg-amber-100 text-amber-700 border-amber-200',
    red: 'bg-red-100 text-red-700 border-red-200',
    blue: 'bg-blue-100 text-blue-700 border-blue-200',
    dark: 'bg-gray-900 text-white border-gray-900'
  };
  return (
    <span className={`px-2.5 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider border ${colors[color] || colors.indigo} ${className}`}>
      {children}
    </span>
  );
};

const CountDown = ({ targetDate }) => {
  const [timeLeft, setTimeLeft] = useState('');
  
  useEffect(() => {
    const interval = setInterval(() => {
      const now = new Date().getTime();
      const distance = new Date(targetDate).getTime() - now;
      
      if (distance < 0) {
        setTimeLeft('CLOSED');
        clearInterval(interval);
      } else {
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        setTimeLeft(`${hours}h ${minutes}m ${seconds}s`);
      }
    }, 1000);
    return () => clearInterval(interval);
  }, [targetDate]);

  return (
    <span className={`font-mono font-bold tracking-tight ${timeLeft === 'CLOSED' ? 'text-red-500' : 'text-indigo-600'}`}>
      {timeLeft}
    </span>
  );
};

/**
 * ==================================================================================
 * HELPER FUNCTIONS
 * ==================================================================================
 */

const isVideo = (url) => {
  if (!url) return false;
  return url.match(/\.(mp4|webm|ogg|mov)$/i) || url.includes('youtube') || url.includes('vimeo'); 
};

/**
 * ==================================================================================
 * MAIN APPLICATION COMPONENT
 * ==================================================================================
 */

export default function App() {
  // --- Global State ---
  const [user, setUser] = useState(null);
  const [view, setView] = useState('auth'); // auth, store, auctions, reels, dashboard, orders, cart
  const [authMode, setAuthMode] = useState('login'); 
  const [products, setProducts] = useState([]);
  const [auctions, setAuctions] = useState([]); 
  const [orders, setOrders] = useState([]);
  const [cart, setCart] = useState([]);
  const [notification, setNotification] = useState(null);
  const [activeOrderChat, setActiveOrderChat] = useState(null);
  const [activeProduct, setActiveProduct] = useState(null); 
  const [loading, setLoading] = useState(true);
  const [isFirebaseReady, setIsFirebaseReady] = useState(false);
  const [muted, setMuted] = useState(true);

  // --- 1. Authentication Lifecycle ---
  useEffect(() => {
    if (!auth) {
        // Fallback for local dev without keys
        setNotification("Error: Firebase keys missing in 'githubConfig'.");
        setLoading(false);
        return;
    }

    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Firebase connection error", err);
      }
    };
    
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      if (u) {
        setIsFirebaseReady(true);
        // Attempt to restore persistent session
        const savedUsername = localStorage.getItem('levstore_username');
        if (savedUsername) {
            restoreSession(savedUsername);
        } else {
            setLoading(false);
        }
      }
    });
    return () => unsubscribe();
  }, []);

  // --- 2. Data Persistence & Sync ---
  const restoreSession = async (username) => {
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', username);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        setUser({ username, ...data });
        setView('store'); // Default to store on restore
        notify(`Welcome back, ${username}`);
      } else {
        localStorage.removeItem('levstore_username');
      }
    } catch (err) {
      console.error("Session restore failed", err);
    } finally {
      setLoading(false);
    }
  };

  const handleRegister = async (username, password, email, role) => {
    if (!isFirebaseReady) return notify("Connecting to cloud...");
    setLoading(true);
    
    // SECURITY: Prevent unauthorized users from taking the LVS handle
    if (username.toUpperCase() === OWNER_USERNAME && email !== OWNER_EMAIL) {
        setLoading(false);
        return notify("Security Alert: This username is reserved for the Owner.");
    }

    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', username);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        notify("Username is already in use.");
        setLoading(false);
        return;
      }
      
      const userData = {
        password, // Note: In production, hash passwords. 
        email,
        role, 
        isAuthorized: email === OWNER_EMAIL, // Only Owner Email gets auto-authorized
        createdAt: new Date().toISOString(), 
        uid: auth.currentUser.uid
      };
      
      await setDoc(docRef, userData);
      localStorage.setItem('levstore_username', username);
      setUser({ username, ...userData });
      setView('store');
      notify("Account created successfully!");
    } catch (err) {
      console.error(err);
      notify("Registration failed. Try again.");
    } finally {
      setLoading(false);
    }
  };

  const handleLogin = async (username, password) => {
    if (!isFirebaseReady) return notify("Connecting to cloud...");
    setLoading(true);
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', username);
      const snap = await getDoc(docRef);
      
      if (snap.exists()) {
        const data = snap.data();
        if (data.password === password) {
          localStorage.setItem('levstore_username', username);
          setUser({ username, ...data });
          setView('store');
          notify("Login successful.");
        } else {
          notify("Incorrect password.");
        }
      } else {
        notify("Account not found.");
      }
    } catch (err) {
      console.error(err);
      notify("Login error. Check connection.");
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = () => {
    localStorage.removeItem('levstore_username');
    setUser(null);
    setView('auth');
    setCart([]);
  };

  // --- 3. Real-time Listeners ---
  useEffect(() => {
    if (!user || !isFirebaseReady || !db) return;
    
    // A. Sync Products
    const prodRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
    const unsubProd = onSnapshot(prodRef, (snap) => {
      setProducts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });

    // B. Sync Auctions
    const auctRef = collection(db, 'artifacts', appId, 'public', 'data', 'auctions');
    const unsubAuct = onSnapshot(auctRef, (snap) => {
      // Sort by ending time
      setAuctions(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => new Date(a.endTime) - new Date(b.endTime)));
    });

    // C. Sync Orders
    const orderRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
    const unsubOrders = onSnapshot(orderRef, (snap) => {
      const allData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      // Filter visible orders
      const myOrders = allData.filter(o => o.buyerUsername === user.username || o.items.some(i => i.sellerUsername === user.username));
      setOrders(myOrders);
    });

    // D. Sync User Data (Self) - For dynamic authorization updates
    const myAcctRef = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', user.username);
    const unsubAcct = onSnapshot(myAcctRef, (snap) => {
      if(snap.exists()) setUser(prev => ({...prev, ...snap.data()}));
    });

    return () => { unsubProd(); unsubOrders(); unsubAcct(); unsubAuct(); };
  }, [user?.username, isFirebaseReady]);

  // --- 4. User Actions ---
  const notify = (msg) => { 
      setNotification(msg); 
      setTimeout(() => setNotification(null), 3000); 
  };

  const addProduct = async (name, price, icon, mediaUrl) => {
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
        name, 
        price: parseFloat(price), 
        icon,
        mediaUrl: mediaUrl || '',
        sellerUsername: user.username,
        sellerAuthorized: user.isAuthorized || false,
        likes: [],
        dislikes: [],
        comments: [],
        createdAt: new Date().toISOString()
      });
      notify("Product listed on Market!");
    } catch (err) { notify("Listing failed."); }
  };

  const startAuction = async (name, startPrice, durationHrs, icon, mediaUrl) => {
    try {
      const endTime = new Date(Date.now() + (durationHrs * 60 * 60 * 1000)).toISOString();
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'auctions'), {
        name,
        startPrice: parseFloat(startPrice),
        currentBid: parseFloat(startPrice),
        highestBidder: null,
        endTime,
        icon,
        mediaUrl: mediaUrl || '',
        sellerUsername: user.username,
        sellerAuthorized: user.isAuthorized || false,
        bids: [],
        createdAt: new Date().toISOString()
      });
      notify("Auction launched successfully!");
    } catch (err) { notify("Failed to start auction."); }
  };

  const placeBid = async (auctionId, currentBid, bidAmount) => {
    if (user.role === 'seller') return notify("Sellers cannot participate in bidding.");
    if (bidAmount <= currentBid) return notify("Bid must be higher than current price.");
    
    try {
      const ref = doc(db, 'artifacts', appId, 'public', 'data', 'auctions', auctionId);
      await updateDoc(ref, {
        currentBid: parseFloat(bidAmount),
        highestBidder: user.username,
        bids: arrayUnion({ user: user.username, amount: parseFloat(bidAmount), time: new Date().toISOString() })
      });
      notify("Bid accepted!");
    } catch(err) { notify("Bid failed to process."); }
  };

  const placeOrder = async () => {
    if (cart.length === 0) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
        buyerUsername: user.username,
        items: cart.map(c => ({...c, sellerUsername: c.sellerUsername})),
        total: cart.reduce((s, i) => s + (i.price * i.quantity), 0),
        status: 'placed',
        statusHistory: [{ status: 'placed', time: new Date().toISOString() }],
        messages: [],
        createdAt: new Date().toISOString()
      });
      setCart([]);
      setView('orders');
      notify("Order confirmed & saved to cloud.");
    } catch (err) { notify("Checkout failed."); }
  };

  const updateOrderStatus = async (orderId, newStatus) => {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId), {
      status: newStatus,
      statusHistory: arrayUnion({ status: newStatus, time: new Date().toISOString() })
    });
    notify(`Order updated: ${newStatus}`);
  };

  const sendMessage = async (orderId, text) => {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;
    const newMsg = { sender: user.username, text, time: new Date().toISOString() };
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId), {
      messages: [...order.messages, newMsg]
    });
  };

  // Social Features
  const handleLike = async (productId, currentLikes) => {
    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
    if (currentLikes?.includes(user.username)) {
      await updateDoc(ref, { likes: arrayRemove(user.username) });
    } else {
      await updateDoc(ref, { likes: arrayUnion(user.username), dislikes: arrayRemove(user.username) });
    }
  };

  const handleDislike = async (productId, currentDislikes) => {
    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
    if (currentDislikes?.includes(user.username)) {
      await updateDoc(ref, { dislikes: arrayRemove(user.username) });
    } else {
      await updateDoc(ref, { dislikes: arrayUnion(user.username), likes: arrayRemove(user.username) });
    }
  };

  const postComment = async (productId, text) => {
    if (!text.trim()) return;
    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
    await updateDoc(ref, {
      comments: arrayUnion({ user: user.username, text, time: new Date().toISOString() })
    });
  };

  // OWNER POWER: Global Delete
  // Can delete from 'products', 'auctions', etc.
  const deleteItem = async (id, collectionName = 'products') => {
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id));
      notify("Item deleted from database.");
    } catch(err) { notify("Deletion failed."); }
  };

  // OWNER POWER: Toggle User Verification
  const verifyUser = async (targetUsername) => {
    if (user.email !== OWNER_EMAIL) return notify("Access Denied: Owner Only.");
    
    try {
      const ref = doc(db, 'artifacts', appId, 'public', 'data', 'accounts', targetUsername);
      const snap = await getDoc(ref);
      
      if (!snap.exists()) {
        return notify(`User '${targetUsername}' not found.`);
      }

      const currentStatus = snap.data().isAuthorized;
      await updateDoc(ref, { isAuthorized: !currentStatus });
      notify(`User '${targetUsername}' status toggled.`);
    } catch(err) {
      console.error(err);
      notify("Operation failed.");
    }
  };

  // --- Sub-components for Views ---

  const OrderStatusStepper = ({ currentStatus }) => {
    const steps = ['placed', 'processing', 'shipped', 'delivered'];
    const currentIndex = steps.indexOf(currentStatus) === -1 ? 0 : steps.indexOf(currentStatus);
    
    return (
      <div className="flex items-center justify-between w-full mt-4 mb-2">
        {steps.map((step, idx) => {
          const completed = idx <= currentIndex;
          const icons = { placed: Clock, processing: Package, shipped: Truck, delivered: CheckCircle };
          const StepIcon = icons[step];
          return (
            <div key={step} className="flex flex-col items-center relative z-10 group">
              <div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 shadow-sm border-2 ${completed ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-gray-200 text-gray-300'}`}>
                 <StepIcon size={16} />
              </div>
              <span className={`text-[10px] font-bold mt-2 uppercase tracking-wider transition-colors ${completed ? 'text-indigo-600' : 'text-gray-400'}`}>{step}</span>
            </div>
          );
        })}
        {/* Connector Line */}
        <div className="absolute left-0 right-0 top-5 h-1 bg-gray-100 -z-0 mx-10 rounded-full overflow-hidden">
           <div className="h-full bg-indigo-600 transition-all duration-700 ease-out" style={{width: `${(currentIndex / (steps.length - 1)) * 100}%`}}></div>
        </div>
      </div>
    );
  };

  // --- Initial Loading State ---
  if (loading) return (
    <div className="min-h-screen bg-white flex flex-col items-center justify-center gap-4">
      <div className="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
      <p className="text-indigo-600 font-bold tracking-widest animate-pulse text-xs uppercase">Connecting to Levstore Cloud...</p>
    </div>
  );

  // --- View: Authentication ---
  if (view === 'auth' || !user) {
    return (
      <div className="min-h-screen flex flex-col lg:flex-row bg-white font-sans text-slate-900">
        {/* Left Side: Brand & Visuals */}
        <div className="lg:w-1/2 bg-gray-50 p-12 flex flex-col justify-between relative overflow-hidden">
          {/* Abstract blobs */}
          <div className="absolute top-0 right-0 w-full h-full opacity-50 pointer-events-none">
             <div className="absolute top-[-10%] right-[-10%] w-[600px] h-[600px] bg-indigo-200 rounded-full blur-[120px] mix-blend-multiply"></div>
             <div className="absolute bottom-[-10%] left-[-10%] w-[500px] h-[500px] bg-purple-200 rounded-full blur-[100px] mix-blend-multiply"></div>
          </div>
          
          <div className="relative z-10">
            <div className="flex items-center gap-3 mb-12">
              <div className="bg-indigo-600 p-2.5 rounded-xl shadow-lg shadow-indigo-200"><StoreIcon className="w-6 h-6 text-white" /></div>
              <div>
                <span className="text-2xl font-black tracking-tighter text-slate-900">LEV<span className="text-indigo-600">STORE</span></span>
                <span className="block text-[10px] font-mono text-gray-400 font-bold">MADE BY LSV</span>
              </div>
            </div>
            <h1 className="text-5xl font-extrabold leading-tight mb-6 text-slate-900">
              {authMode === 'login' ? 'Welcome Back.' : 'Join the Elite Market.'}
            </h1>
            <p className="text-gray-500 text-lg max-w-md leading-relaxed font-medium">
              A secure, cloud-based marketplace for digital assets. Sign in to manage your inventory and auctions from anywhere.
            </p>
          </div>
          
          <div className="relative z-10 flex gap-8 pt-8 border-t border-gray-200">
             <div>
                <p className="text-2xl font-black text-indigo-600">10k+</p>
                <p className="text-xs font-bold text-gray-400 uppercase tracking-wider">Active Items</p>
             </div>
             <div>
                <p className="text-2xl font-black text-indigo-600">24h</p>
                <p className="text-xs font-bold text-gray-400 uppercase tracking-wider">Cloud Sync</p>
             </div>
          </div>
        </div>

        {/* Right Side: Form */}
        <div className="lg:w-1/2 p-8 lg:p-24 flex flex-col justify-center bg-white">
          <div className="max-w-md w-full mx-auto">
            <h2 className="text-3xl font-black mb-2 text-slate-900">{authMode === 'login' ? 'Sign In' : 'Create Account'}</h2>
            <p className="text-gray-400 mb-10 font-medium">{authMode === 'login' ? 'Enter your details to access your dashboard.' : 'Fill in the information below to get started.'}</p>
            
            <form onSubmit={(e) => {
              e.preventDefault();
              const fd = new FormData(e.target);
              if (authMode === 'login') handleLogin(fd.get('username'), fd.get('password'));
              else handleRegister(fd.get('username'), fd.get('password'), fd.get('email'), fd.get('role'));
            }}>
              <Input label="Username" name="username" placeholder="johndoe" icon={User} required />
              
              {authMode === 'register' && (
                <>
                  <Input label="Email Address" name="email" type="email" placeholder="you@example.com" icon={Mail} required />
                  <div className="mb-6">
                    <label className="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 ml-1">Account Type</label>
                    <div className="grid grid-cols-2 gap-4">
                      <label className="cursor-pointer group relative">
                        <input type="radio" name="role" value="buyer" defaultChecked className="hidden peer" />
                        <div className="p-4 border-2 border-gray-100 rounded-xl text-center peer-checked:border-indigo-600 peer-checked:bg-indigo-50 peer-checked:text-indigo-600 font-bold text-gray-400 transition-all duration-200 hover:border-gray-200">
                           <div className="mb-1 flex justify-center"><ShoppingCart size={20}/></div>
                           Buyer
                        </div>
                      </label>
                      <label className="cursor-pointer group relative">
                        <input type="radio" name="role" value="seller" className="hidden peer" />
                        <div className="p-4 border-2 border-gray-100 rounded-xl text-center peer-checked:border-indigo-600 peer-checked:bg-indigo-50 peer-checked:text-indigo-600 font-bold text-gray-400 transition-all duration-200 hover:border-gray-200">
                           <div className="mb-1 flex justify-center"><Briefcase size={20}/></div>
                           Seller
                        </div>
                      </label>
                    </div>
                  </div>
                </>
              )}
              
              <Input label="Password" name="password" type="password" placeholder="••••••••" icon={Lock} required />
              
              <Button type="submit" className="w-full py-4 mt-6 text-base" disabled={loading}>
                {loading ? 'Processing...' : (authMode === 'login' ? 'Sign In' : 'Create Account')}
              </Button>
            </form>

            <div className="mt-8 text-center text-sm font-medium text-gray-500">
              {authMode === 'login' ? "New to Levstore?" : "Already have an account?"}
              <button onClick={() => setAuthMode(authMode === 'login' ? 'register' : 'login')} className="ml-2 font-bold text-indigo-600 hover:underline">
                {authMode === 'login' ? 'Create Account' : 'Log In'}
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // --- View: Main Application ---
  return (
    <div className="min-h-screen bg-[#F8FAFC] text-slate-900 pb-32 font-sans selection:bg-indigo-200 selection:text-indigo-900">
      
      {/* Toast Notification */}
      {notification && (
        <div className="fixed top-24 right-6 z-[100] bg-white border border-gray-100 text-slate-800 px-6 py-4 rounded-2xl shadow-xl flex items-center gap-3 animate-bounce">
          <div className="bg-indigo-100 p-2 rounded-full text-indigo-600"><Sparkles size={18} /></div>
          <span className="font-bold text-sm">{notification}</span>
        </div>
      )}

      {/* Navigation Bar */}
      <nav className="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-gray-200/60 supports-[backdrop-filter]:bg-white/60">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 h-20 flex justify-between items-center">
          
          {/* Logo Area */}
          <div className="flex items-center gap-3 cursor-pointer group" onClick={() => setView('store')}>
            <div className="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-200 group-hover:scale-105 transition-transform"><StoreIcon className="w-5 h-5 text-white" /></div>
            <div>
               <span className="font-black text-xl tracking-tighter leading-none text-slate-900">LEV<span className="text-indigo-600">STORE</span></span>
               <span className="block text-[9px] font-bold text-gray-400 tracking-widest">MADE BY LSV</span>
            </div>
          </div>

          {/* Nav Links */}
          <div className="hidden md:flex items-center gap-1 bg-gray-100/50 p-1 rounded-xl">
            {[
                { id: 'store', label: 'Market', icon: StoreIcon },
                { id: 'auctions', label: 'Auctions', icon: Gavel },
                { id: 'reels', label: 'Reels', icon: Film },
                ...(user?.role === 'seller' ? [{ id: 'dashboard', label: 'Sell', icon: Briefcase }] : []),
                { id: 'orders', label: 'Orders', icon: Package },
            ].map(link => (
                <button 
                    key={link.id}
                    onClick={() => setView(link.id)}
                    className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider flex items-center gap-2 transition-all ${view === link.id ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-200/50'}`}
                >
                    <link.icon size={14}/> {link.label}
                </button>
            ))}
          </div>

          {/* Right Actions */}
          <div className="flex items-center gap-4">
            <button onClick={() => setView('cart')} className="relative p-2.5 bg-white border border-gray-200 rounded-xl text-gray-600 hover:border-indigo-600 hover:text-indigo-600 transition-all group">
              <ShoppingCart size={20} />
              {cart.length > 0 && <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-[10px] font-bold text-white flex items-center justify-center rounded-full border-2 border-white shadow-sm">{cart.length}</span>}
            </button>

            <div className="flex items-center gap-3 pl-4 border-l border-gray-200">
              <div 
                className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-xl flex items-center justify-center font-black text-sm uppercase shadow-md cursor-pointer hover:shadow-lg transition-all"
                title={`Logged in as ${user.username}`}
              >
                {user?.username?.[0]}
              </div>
              <button onClick={handleLogout} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="Log Out"><LogOut size={18}/></button>
            </div>
          </div>
        </div>
      </nav>

      {/* Main Content Area */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
        
        {/* === VIEW: STORE === */}
        {view === 'store' && (
          <div className="space-y-12 animate-in fade-in duration-500">
            {/* Hero Section */}
            <div className="bg-indigo-600 rounded-[2.5rem] p-10 sm:p-16 text-white relative overflow-hidden shadow-2xl shadow-indigo-200 min-h-[320px] flex items-center">
               <div className="relative z-10 max-w-xl">
                 <Badge color="dark" className="bg-black/20 text-white border-none backdrop-blur mb-4 inline-block">New Collection</Badge>
                 <h2 className="text-4xl sm:text-6xl font-black mb-6 leading-tight">The Future of <br/><span className="text-indigo-200">Digital Commerce</span></h2>
                 <p className="text-indigo-100 text-lg mb-8 opacity-90 font-medium max-w-md">Browse verified listings, bid on exclusive items, and experience the next generation of cloud retail.</p>
                 <div className="flex gap-4">
                    <Button onClick={() => setView('reels')} variant="glass" icon={Film}>Watch Reels</Button>
                    <Button onClick={() => setView('auctions')} variant="glass" icon={Gavel}>Live Auctions</Button>
                 </div>
               </div>
               {/* Decorative background elements */}
               <div className="absolute right-[-10%] top-[-50%] w-[600px] h-[600px] bg-white/10 rounded-full blur-[80px]"></div>
               <div className="absolute right-[20%] bottom-[-50%] w-[400px] h-[400px] bg-purple-500/30 rounded-full blur-[80px]"></div>
            </div>

            {/* Product Grid */}
            <div>
                <div className="flex justify-between items-end mb-8">
                    <h3 className="text-2xl font-black text-slate-900">Featured Items</h3>
                    <div className="flex gap-2">
                        <button className="p-2 bg-white border border-gray-200 rounded-lg text-gray-500 hover:text-indigo-600"><Search size={18}/></button>
                        <button className="p-2 bg-white border border-gray-200 rounded-lg text-gray-500 hover:text-indigo-600"><Filter size={18}/></button>
                    </div>
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                {products.map(p => (
                    <div key={p.id} onClick={() => setActiveProduct(p)} className="bg-white group cursor-pointer rounded-[2rem] p-4 border border-gray-100 hover:shadow-xl hover:border-indigo-100 hover:-translate-y-1 transition-all duration-300 flex flex-col h-full relative">
                    {/* Media Container */}
                    <div className="aspect-square bg-gray-50 rounded-[1.5rem] overflow-hidden mb-4 relative">
                        {p.mediaUrl ? (
                            isVideo(p.mediaUrl) ? <video src={p.mediaUrl} className="w-full h-full object-cover" muted loop onMouseOver={e => e.target.play()} onMouseOut={e => e.target.pause()} /> 
                            : <img src={p.mediaUrl} alt={p.name} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                        ) : (
                        <div className="w-full h-full flex items-center justify-center text-7xl text-gray-300"><span className="group-hover:scale-110 transition-transform duration-500 grayscale group-hover:grayscale-0">{p.icon}</span></div>
                        )}
                        
                        <div className="absolute bottom-3 right-3 flex gap-2 translate-y-10 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300">
                            <div className="bg-white/90 backdrop-blur px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1 shadow-sm"><Heart size={14} className="text-red-500" /> {p.likes?.length || 0}</div>
                        </div>

                        {/* OWNER DELETE BUTTON - Shows ONLY for Owner Email */}
                        {user.email === OWNER_EMAIL && (
                            <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    if(window.confirm("Admin: Delete this item?")) deleteItem(p.id, 'products');
                                }}
                                className="absolute top-3 left-3 p-2 bg-red-600 text-white rounded-full shadow-lg z-20 hover:bg-red-700 hover:scale-110 transition-all"
                                title="Owner Delete"
                            >
                                <Trash2 size={16} />
                            </button>
                        )}
                    </div>

                    <div className="px-1 flex flex-col flex-1">
                        <div className="flex justify-between items-start mb-2">
                        <h3 className="font-black text-lg text-slate-900 truncate flex-1 pr-2 leading-tight">{p.name}</h3>
                        <span className="font-black text-indigo-600 bg-indigo-50 px-2 py-1 rounded-lg text-sm">${p.price}</span>
                        </div>
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-6 flex items-center gap-1">
                        @{p.sellerUsername} {p.sellerAuthorized && <BadgeCheck size={14} className="text-blue-500 fill-blue-50" />}
                        </p>
                        
                        {user.role === 'buyer' ? (
                            <Button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    setCart(prev => {
                                        const ex = prev.find(i => i.id === p.id);
                                        return ex ? prev.map(i => i.id === p.id ? {...i, quantity: i.quantity+1} : i) : [...prev, {...p, quantity: 1}];
                                    });
                                    notify(`Added ${p.name} to cart`);
                                }}
                                className="w-full rounded-xl py-3 mt-auto shadow-none bg-gray-900 hover:bg-black" 
                            >
                                Add to Cart
                            </Button>
                        ) : (
                            <Button disabled className="w-full rounded-xl py-3 mt-auto bg-gray-100 text-gray-400 shadow-none cursor-not-allowed border-none">
                                Seller Account
                            </Button>
                        )}
                    </div>
                    </div>
                ))}
                </div>
                {products.length === 0 && (
                    <div className="text-center py-20 bg-white border-2 border-dashed border-gray-200 rounded-[2rem]">
                        <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300"><Package size={32}/></div>
                        <p className="text-gray-400 font-bold">No products listed yet.</p>
                    </div>
                )}
            </div>
          </div>
        )}

        {/* === VIEW: AUCTIONS === */}
        {view === 'auctions' && (
          <div className="space-y-10 animate-in fade-in duration-500">
             <div className="text-center max-w-2xl mx-auto mb-16">
               <div className="bg-indigo-100 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 text-indigo-600 shadow-inner"><Gavel size={40}/></div>
               <h2 className="text-5xl font-black mb-6 text-slate-900 tracking-tight">Auction House</h2>
               <p className="text-gray-500 text-lg font-medium">Place your bids on exclusive items in real-time. Winners are secured by cloud contracts instantly upon closure.</p>
             </div>

             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
               {auctions.map(a => {
                  const isEnded = new Date(a.endTime) < new Date();
                  return (
                    <div key={a.id} className="bg-white rounded-[2rem] border border-gray-100 overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 relative group">
                       <div className="h-56 bg-gray-100 relative overflow-hidden">
                          {a.mediaUrl ? (isVideo(a.mediaUrl) ? <video src={a.mediaUrl} className="w-full h-full object-cover"/> : <img src={a.mediaUrl} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"/>) : <div className="w-full h-full flex items-center justify-center text-7xl text-gray-300">{a.icon}</div>}
                          
                          <div className="absolute top-4 right-4 bg-white/90 backdrop-blur text-slate-900 px-3 py-1.5 rounded-lg text-xs font-mono font-bold flex items-center gap-2 shadow-sm">
                             <Timer size={14} className="text-red-500"/> <CountDown targetDate={a.endTime} />
                          </div>

                          {/* OWNER DELETE BUTTON */}
                          {user.email === OWNER_EMAIL && (
                            <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    if(window.confirm("Admin: Delete this auction?")) deleteItem(a.id, 'auctions');
                                }}
                                className="absolute top-4 left-4 p-2 bg-red-600 text-white rounded-lg shadow-lg hover:bg-red-700 transition-colors z-20"
                            >
                                <Trash2 size={16} />
                            </button>
                          )}
                       </div>
                       
                       <div className="p-6">
                          <div className="flex justify-between items-start mb-2">
                             <h3 className="text-xl font-black text-slate-900">{a.name}</h3>
                             <Badge color="indigo">Live</Badge>
                          </div>
                          <p className="text-xs text-gray-400 font-bold uppercase tracking-widest mb-6">Seller: {a.sellerUsername}</p>
                          
                          <div className="bg-gray-50 rounded-2xl p-5 mb-6 flex justify-between items-end border border-gray-100">
                             <div>
                               <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">Current Bid</p>
                               <p className="text-3xl font-black text-indigo-600">${a.currentBid}</p>
                             </div>
                             <div className="text-right">
                               <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Highest Bidder</p>
                               <p className="text-sm font-bold text-slate-900">{a.highestBidder || 'None'}</p>
                             </div>
                          </div>

                          {!isEnded ? (
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                placeBid(a.id, a.currentBid, e.target.bid.value);
                                e.target.reset();
                            }} className="flex gap-3">
                                <input 
                                    name="bid" 
                                    type="number" 
                                    step="1" 
                                    min={a.currentBid + 1} 
                                    placeholder={`Min $${a.currentBid + 1}`} 
                                    className="flex-1 bg-white border-2 border-gray-100 rounded-xl px-4 font-bold outline-none focus:border-indigo-600 transition-all text-sm" 
                                    required 
                                />
                                <Button type="submit" variant="dark" disabled={user.role === 'seller'} className="px-6">Bid</Button>
                            </form>
                          ) : (
                            <div className="bg-red-50 text-red-600 font-bold text-center py-3 rounded-xl uppercase tracking-widest text-xs border border-red-100">Auction Ended</div>
                          )}
                          {user.role === 'seller' && <p className="text-[10px] text-center text-gray-400 mt-3 font-bold uppercase tracking-wide">Sellers cannot bid</p>}
                       </div>
                    </div>
                  );
               })}
             </div>
             {auctions.length === 0 && <p className="text-center text-gray-400 font-bold py-10">No active auctions found.</p>}
          </div>
        )}

        {/* === VIEW: REELS === */}
        {view === 'reels' && (
          <div className="max-w-md mx-auto h-[80vh] bg-black rounded-[3rem] overflow-hidden shadow-2xl relative animate-in fade-in border-[8px] border-gray-900">
             <div className="absolute top-6 right-6 z-20 flex flex-col gap-4">
                <button onClick={() => setMuted(!muted)} className="bg-black/40 backdrop-blur-md p-3 rounded-full text-white hover:bg-black/60 transition-all border border-white/10">
                   {muted ? <VolumeX size={20}/> : <Volume2 size={20}/>}
                </button>
                <button onClick={() => setView('store')} className="bg-black/40 backdrop-blur-md p-3 rounded-full text-white hover:bg-black/60 transition-all border border-white/10">
                   <X size={20}/>
                </button>
             </div>

             <div className="snap-y snap-mandatory h-full overflow-y-scroll no-scrollbar scroll-smooth">
                {products.map(p => (
                   <div key={p.id} className="snap-center h-full w-full relative flex items-center justify-center bg-gray-900">
                      {p.mediaUrl ? (
                         isVideo(p.mediaUrl) ? (
                            <video src={p.mediaUrl} className="w-full h-full object-cover" autoPlay muted={muted} loop playsInline />
                         ) : <img src={p.mediaUrl} alt={p.name} className="w-full h-full object-cover opacity-80" />
                      ) : (
                        <div className="text-9xl animate-bounce text-gray-600">{p.icon}</div>
                      )}
                      
                      {/* OWNER DELETE BUTTON */}
                      {user.email === OWNER_EMAIL && (
                        <button 
                            onClick={(e) => {
                                e.stopPropagation();
                                if(window.confirm("Admin: Delete this reel?")) deleteItem(p.id, 'products');
                            }}
                            className="absolute top-6 left-6 p-3 bg-red-600 text-white rounded-full shadow-lg z-30 hover:bg-red-700 pointer-events-auto"
                        >
                            <Trash2 size={20} />
                        </button>
                      )}

                      <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent pointer-events-none"></div>
                      
                      <div className="absolute bottom-0 left-0 right-0 p-8 pb-12 text-white pointer-events-auto">
                         <div className="flex items-end justify-between">
                            <div className="flex-1 pr-4">
                               <div className="flex items-center gap-2 mb-3">
                                  <div className="bg-indigo-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs shadow-lg">{p.sellerUsername[0]}</div>
                                  <span className="font-bold text-sm text-indigo-200 drop-shadow-md">@{p.sellerUsername}</span>
                                  {p.sellerAuthorized && <BadgeCheck size={16} className="text-blue-400 fill-blue-900"/>}
                               </div>
                               <h2 className="text-3xl font-black mb-2 leading-tight drop-shadow-lg">{p.name}</h2>
                               <p className="text-3xl font-bold text-emerald-400 font-mono tracking-tight">${p.price}</p>
                            </div>
                            
                            <div className="flex flex-col gap-4 items-center">
                               <button onClick={() => setActiveProduct(p)} className="bg-white/10 backdrop-blur-md p-3 rounded-full hover:bg-white/20 transition-all border border-white/10">
                                  <MessageSquare size={24} className="text-white"/>
                               </button>
                               {user.role === 'buyer' && (
                                <button onClick={() => {
                                    setCart(prev => {
                                        const ex = prev.find(i => i.id === p.id);
                                        return ex ? prev.map(i => i.id === p.id ? {...i, quantity: i.quantity+1} : i) : [...prev, {...p, quantity: 1}];
                                    });
                                    notify("Added to Cart!");
                                }} className="bg-white text-indigo-600 p-4 rounded-full shadow-lg hover:scale-110 active:scale-95 transition-all">
                                    <Plus size={28} strokeWidth={3}/>
                                </button>
                               )}
                            </div>
                         </div>
                      </div>
                   </div>
                ))}
             </div>
          </div>
        )}

        {/* === VIEW: SELLER DASHBOARD === */}
        {view === 'dashboard' && user.role === 'seller' && (
          <div className="grid lg:grid-cols-12 gap-8 lg:gap-12 animate-in fade-in duration-500">
             <div className="lg:col-span-4 space-y-8">
               {/* Profile Card */}
               <div className="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-lg text-center relative overflow-hidden">
                  <div className="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-indigo-500 to-purple-600"></div>
                  <div className="w-24 h-24 bg-white rounded-[2rem] mx-auto flex items-center justify-center text-4xl mb-4 relative z-10 -mt-12 shadow-xl border-4 border-white">
                      <span className="font-black text-indigo-600">{user.username[0]}</span>
                  </div>
                  <h3 className="font-black text-2xl flex items-center justify-center gap-2 text-slate-900">
                    {user.username} {user.isAuthorized && <BadgeCheck size={22} className="text-blue-500 fill-blue-50"/>}
                  </h3>
                  <p className="text-gray-400 text-sm font-bold uppercase tracking-widest mt-1">Official Seller</p>
                  
                  {/* OWNER ONLY PANEL */}
                  {user.email === OWNER_EMAIL && (
                     <div className="mt-8 pt-6 border-t border-gray-100 text-left">
                        <h4 className="font-black text-indigo-600 flex items-center gap-2 mb-4 text-xs uppercase tracking-widest"><Shield size={14}/> Owner Controls</h4>
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            verifyUser(e.target.targetUser.value);
                            e.target.reset();
                        }} className="flex flex-col gap-2">
                           <Input name="targetUser" placeholder="Enter username..." className="text-xs" />
                           <Button type="submit" variant="dark" className="w-full text-xs py-2">Toggle Verification</Button>
                        </form>
                     </div>
                  )}
               </div>

               {/* Add Product Form */}
               <div className="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-lg">
                 <h3 className="text-xl font-black mb-6 flex items-center gap-2"><Plus className="text-indigo-600"/> List New Item</h3>
                 <form onSubmit={(e) => {
                   e.preventDefault();
                   const fd = new FormData(e.target);
                   addProduct(fd.get('name'), fd.get('price'), fd.get('icon'), fd.get('mediaUrl'));
                   e.target.reset();
                 }}>
                   <Input label="Icon" name="icon" placeholder="🎁" required />
                   <Input label="Name" name="name" placeholder="Pro Gadget" required />
                   <Input label="Price ($)" name="price" type="number" placeholder="49.99" icon={DollarSign} required />
                   <Input label="Image/Video URL" name="mediaUrl" placeholder="https://..." icon={ImageIcon} />
                   <Button type="submit" className="w-full mt-4 shadow-lg shadow-indigo-100" variant="primary">Post to Cloud</Button>
                 </form>
               </div>

               {/* Add Auction Form */}
               <div className="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-lg">
                 <h3 className="text-xl font-black mb-6 flex items-center gap-2"><Gavel className="text-indigo-600"/> Start Auction</h3>
                 <form onSubmit={(e) => {
                   e.preventDefault();
                   const fd = new FormData(e.target);
                   startAuction(fd.get('name'), fd.get('price'), fd.get('duration'), fd.get('icon'), fd.get('mediaUrl'));
                   e.target.reset();
                 }}>
                   <Input label="Item Name" name="name" placeholder="Rare Item" required />
                   <Input label="Start Bid ($)" name="price" type="number" placeholder="10.00" icon={DollarSign} required />
                   <Input label="Duration (Hours)" name="duration" type="number" placeholder="24" icon={Clock} required />
                   <Input label="Icon" name="icon" placeholder="💎" required />
                   <Input label="Image/Video URL" name="mediaUrl" placeholder="https://..." icon={ImageIcon} />
                   <Button type="submit" className="w-full mt-4 shadow-lg shadow-gray-200" variant="dark">Launch Auction</Button>
                 </form>
               </div>
             </div>
             
             <div className="lg:col-span-8 space-y-12">
               {/* Order Management */}
               <div>
                    <h2 className="text-3xl font-black mb-6 text-slate-900">Incoming Orders</h2>
                    <div className="space-y-6">
                        {orders.filter(o => o.items.some(i => i.sellerUsername === user.username)).map(order => (
                            <div key={order.id} className="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-md hover:shadow-lg transition-all">
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest bg-gray-50 px-2 py-1 rounded-md">Order #{order.id.slice(-6)}</span>
                                        <div className="flex items-center gap-2 mt-2">
                                            <span className={`w-2.5 h-2.5 rounded-full ${order.status === 'delivered' ? 'bg-emerald-500' : 'bg-amber-500 animate-pulse'}`}></span>
                                            <span className="font-bold text-sm uppercase text-slate-900">{order.status}</span>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 bg-gray-50 p-1 rounded-xl">
                                        {['processing', 'shipped', 'delivered'].map(s => (
                                            <button 
                                                key={s}
                                                onClick={() => updateOrderStatus(order.id, s)}
                                                className={`px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wide transition-all ${order.status === s ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}
                                            >
                                                {s}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="space-y-3 bg-gray-50 rounded-2xl p-4">
                                    {order.items.filter(i => i.sellerUsername === user.username).map((item, idx) => (
                                        <div key={idx} className="flex items-center justify-between text-sm">
                                            <span className="flex items-center gap-3 font-bold text-slate-700">
                                                <span className="text-xl">{item.icon}</span> 
                                                {item.name} 
                                                <span className="text-gray-400 text-xs">x{item.quantity}</span>
                                            </span>
                                            <span className="font-mono font-bold text-indigo-600">${item.price}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                        {orders.filter(o => o.items.some(i => i.sellerUsername === user.username)).length === 0 && (
                            <div className="text-center py-12 bg-white rounded-[2rem] border-2 border-dashed border-gray-200">
                                <p className="text-gray-400 font-bold">No pending orders.</p>
                            </div>
                        )}
                    </div>
               </div>
               
               {/* Inventory List */}
               <div>
                    <h2 className="text-3xl font-black mb-6 text-slate-900">Your Inventory</h2>
                    <div className="grid gap-4">
                        {products.filter(p => p.sellerUsername === user.username).map(p => (
                        <div key={p.id} className="bg-white p-4 rounded-2xl border border-gray-100 flex items-center gap-6 group hover:border-indigo-100 transition-all">
                            <div className="w-20 h-20 bg-gray-50 rounded-xl overflow-hidden flex-shrink-0 flex items-center justify-center">
                                {p.mediaUrl ? <img src={p.mediaUrl} className="w-full h-full object-cover"/> : <span className="text-3xl">{p.icon}</span>}
                            </div>
                            <div className="flex-1 min-w-0">
                            <h4 className="font-black text-lg truncate text-slate-900">{p.name}</h4>
                            <p className="text-indigo-600 font-bold font-mono">${p.price}</p>
                            <div className="flex gap-4 mt-2 text-xs font-bold text-gray-400">
                                <span className="flex items-center gap-1"><Heart size={12}/> {p.likes?.length || 0}</span>
                                <span className="flex items-center gap-1"><MessageSquare size={12}/> {p.comments?.length || 0}</span>
                            </div>
                            </div>
                            <button onClick={() => deleteItem(p.id)} className="p-3 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all"><Trash2 size={20}/></button>
                        </div>
                        ))}
                    </div>
               </div>
             </div>
          </div>
        )}

        {/* === VIEW: ORDER HISTORY === */}
        {view === 'orders' && (
          <div className="max-w-4xl mx-auto space-y-8 animate-in fade-in duration-500">
            <h2 className="text-4xl font-black mb-8 text-slate-900">Order History</h2>
            {orders.map(order => (
              <div key={order.id} className="bg-white rounded-[2.5rem] border border-gray-100 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                <div className="p-8 bg-gray-50/50 flex justify-between items-center border-b border-gray-100">
                   <div>
                     <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Contract ID</p>
                     <p className="font-mono text-sm font-bold text-indigo-600">#{order.id.slice(-8).toUpperCase()}</p>
                   </div>
                   <div className="text-right">
                     <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Total Amount</p>
                     <p className="font-black text-2xl text-slate-900">${order.total.toFixed(2)}</p>
                   </div>
                </div>
                <div className="p-8">
                  <div className="mb-10">
                     <div className="flex justify-between items-center mb-4">
                        <p className="text-xs font-bold text-gray-500 uppercase tracking-wide">Status</p>
                        <span className="text-xs font-black text-indigo-600 uppercase bg-indigo-50 px-3 py-1 rounded-full">{order.status}</span>
                     </div>
                     <OrderStatusStepper currentStatus={order.status} />
                  </div>

                  <div className="space-y-4 mb-8">
                    {order.items.map((it, idx) => (
                        <div key={idx} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl">
                            <div className="flex items-center gap-4">
                                <span className="text-2xl">{it.icon}</span> 
                                <div>
                                    <p className="font-bold text-slate-900 text-sm">{it.name}</p>
                                    <p className="text-xs font-bold text-gray-400 uppercase tracking-wider">Qty: {it.quantity}</p>
                                </div>
                            </div>
                            <span className="font-mono font-bold text-slate-600">${(it.price * it.quantity).toFixed(2)}</span>
                        </div>
                    ))}
                  </div>
                  <div className="pt-6 border-t border-gray-100 flex justify-between items-center">
                    <span className="text-xs font-bold text-emerald-600 flex items-center gap-2 bg-emerald-50 px-3 py-1.5 rounded-lg"><Shield size={14}/> Encrypted Transaction</span>
                    <Button variant="secondary" onClick={() => setActiveOrderChat(order)} className="!py-2 !px-6 text-xs shadow-none">
                      <MessageSquare size={14}/> Support Chat ({order.messages.length})
                    </Button>
                  </div>
                </div>
              </div>
            ))}
            {orders.length === 0 && (
                <div className="text-center py-20 bg-white rounded-[3rem] border border-gray-100">
                    <p className="text-gray-400 font-bold uppercase tracking-widest">No order history found</p>
                </div>
            )}
          </div>
        )}

        {/* === VIEW: SHOPPING CART === */}
        {view === 'cart' && (
           <div className="max-w-5xl mx-auto grid lg:grid-cols-3 gap-12 animate-in fade-in duration-500">
             <div className="lg:col-span-2 space-y-6">
                <h2 className="text-3xl font-black mb-8 text-slate-900">Your Cart</h2>
                {cart.map(item => (
                  <div key={item.id} className="bg-white p-6 rounded-[2rem] border border-gray-100 flex items-center gap-6 shadow-sm">
                    <div className="w-24 h-24 bg-gray-50 flex-shrink-0 flex items-center justify-center rounded-[1.5rem] overflow-hidden">
                       {item.mediaUrl ? <img src={item.mediaUrl} className="w-full h-full object-cover"/> : <span className="text-4xl">{item.icon}</span>}
                    </div>
                    <div className="flex-1 min-w-0">
                      <h4 className="font-black text-xl truncate text-slate-900">{item.name}</h4>
                      <p className="text-indigo-600 font-bold tracking-tight font-mono text-lg">${item.price}</p>
                    </div>
                    <div className="flex items-center gap-4 bg-gray-50 p-2 rounded-xl border border-gray-100">
                       <button onClick={() => setCart(cart.map(i => i.id === item.id ? {...i, quantity: Math.max(1, i.quantity-1)} : i))} className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-lg transition-colors font-bold text-gray-400 shadow-sm">-</button>
                       <span className="font-black w-6 text-center text-slate-900">{item.quantity}</span>
                       <button onClick={() => setCart(cart.map(i => i.id === item.id ? {...i, quantity: i.quantity+1} : i))} className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-lg transition-colors font-bold text-gray-400 shadow-sm">+</button>
                    </div>
                  </div>
                ))}
                {cart.length === 0 && <div className="text-center py-20 bg-white rounded-[2.5rem] border border-gray-100 text-gray-400 font-bold uppercase tracking-widest">Cart is empty</div>}
             </div>
             <div className="lg:col-span-1">
                <div className="bg-white p-8 rounded-[2.5rem] border border-indigo-50 shadow-xl shadow-indigo-50 sticky top-28">
                   <h3 className="text-xl font-black mb-8 text-slate-900">Summary</h3>
                   <div className="space-y-4 mb-8">
                      <div className="flex justify-between text-gray-400 font-bold text-sm"><span>Subtotal</span><span>${cart.reduce((s,i)=>s+(i.price*i.quantity),0).toFixed(2)}</span></div>
                      <div className="flex justify-between text-gray-400 font-bold text-sm"><span>Taxes</span><span>$0.00</span></div>
                      <div className="h-px bg-gray-100 w-full my-4"></div>
                      <div className="flex justify-between text-slate-900 font-black text-3xl"><span>Total</span><span>${cart.reduce((s,i)=>s+(i.price*i.quantity),0).toFixed(2)}</span></div>
                   </div>
                   <Button onClick={placeOrder} className="w-full py-4 text-lg shadow-lg shadow-indigo-200" disabled={cart.length === 0}>Complete Purchase</Button>
                   <div className="mt-6 flex justify-center gap-2">
                      <div className="w-8 h-5 bg-gray-100 rounded"></div>
                      <div className="w-8 h-5 bg-gray-100 rounded"></div>
                      <div className="w-8 h-5 bg-gray-100 rounded"></div>
                   </div>
                   <p className="text-[10px] text-gray-300 text-center mt-2 font-black uppercase tracking-[0.2em]">Secure Checkout</p>
                </div>
             </div>
           </div>
        )}
      </main>

      {/* === MODAL: Product Details / Comments === */}
      {activeProduct && (
        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[85vh] animate-in zoom-in-95 duration-300">
                <div className="p-6 bg-white border-b border-gray-100 flex justify-between items-center sticky top-0 z-10">
                    <h3 className="font-black text-xl text-slate-900 truncate pr-4">{activeProduct.name}</h3>
                    <button onClick={() => setActiveProduct(null)} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100 transition-colors"><X size={20}/></button>
                </div>
                <div className="flex-1 overflow-y-auto p-8">
                    <div className="flex gap-6 mb-8">
                        <div className="w-32 h-32 bg-gray-50 rounded-[1.5rem] flex items-center justify-center overflow-hidden flex-shrink-0 shadow-inner">
                            {activeProduct.mediaUrl ? (isVideo(activeProduct.mediaUrl) ? <video src={activeProduct.mediaUrl} className="w-full h-full object-cover"/> : <img src={activeProduct.mediaUrl} className="w-full h-full object-cover"/>) : <span className="text-5xl">{activeProduct.icon}</span>}
                        </div>
                        <div>
                            <p className="text-4xl font-black text-indigo-600 mb-2">${activeProduct.price}</p>
                            <p className="text-sm font-bold text-gray-500 mb-4 flex items-center gap-2">
                                <User size={14}/> {activeProduct.sellerUsername}
                                {activeProduct.sellerAuthorized && <BadgeCheck size={16} className="text-blue-500 fill-blue-50"/>}
                            </p>
                            <div className="flex gap-4">
                                <button onClick={() => handleLike(activeProduct.id, activeProduct.likes)} className={`flex items-center gap-2 font-bold px-4 py-2 rounded-xl transition-colors ${activeProduct.likes?.includes(user.username) ? 'bg-indigo-50 text-indigo-600' : 'bg-gray-50 text-gray-400'}`}>
                                    <Heart size={18} className={activeProduct.likes?.includes(user.username) ? 'fill-indigo-600' : ''}/> {activeProduct.likes?.length || 0}
                                </button>
                                <button className="flex items-center gap-2 font-bold px-4 py-2 rounded-xl bg-gray-50 text-gray-400">
                                    <Share2 size={18}/> Share
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="border-t border-gray-100 pt-8">
                        <h4 className="font-black text-lg mb-6 flex items-center gap-2"><MessageSquare className="text-indigo-600"/> Comments ({activeProduct.comments?.length || 0})</h4>
                        
                        <div className="space-y-4 mb-8 max-h-60 overflow-y-auto pr-2">
                            {activeProduct.comments?.length === 0 && <p className="text-gray-400 text-sm font-medium italic">No comments yet. Be the first!</p>}
                            {activeProduct.comments?.map((c, i) => (
                                <div key={i} className="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="text-xs font-black text-indigo-600">@{c.user}</span>
                                        <span className="text-[10px] font-bold text-gray-300 uppercase">{new Date(c.time).toLocaleDateString()}</span>
                                    </div>
                                    <p className="text-sm text-slate-700 font-medium leading-relaxed">{c.text}</p>
                                </div>
                            ))}
                        </div>
                        
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            const val = e.target.comment.value;
                            postComment(activeProduct.id, val);
                            e.target.comment.value = '';
                        }} className="flex gap-3">
                            <input name="comment" className="flex-1 bg-gray-50 border-2 border-gray-100 rounded-xl px-4 py-3 outline-none focus:border-indigo-600 transition-all font-medium text-sm" placeholder="Write a comment..." />
                            <Button type="submit" variant="dark" className="px-6">Post</Button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
      )}

      {/* === MODAL: Order Chat === */}
      {activeOrderChat && (
        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-4">
           <div className="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col h-[650px] animate-in zoom-in-95 duration-300">
              <div className="p-6 bg-indigo-600 text-white flex justify-between items-center">
                 <div>
                   <h4 className="font-black text-lg">Support Chat</h4>
                   <p className="text-xs text-indigo-200 font-bold tracking-widest uppercase">Order #{activeOrderChat.id.slice(-6)}</p>
                 </div>
                 <button onClick={() => setActiveOrderChat(null)} className="p-2 bg-white/10 rounded-xl hover:bg-white/20 transition-all"><X size={20}/></button>
              </div>
              <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50">
                 <div className="text-center">
                    <span className="bg-slate-200 text-slate-500 text-[10px] font-bold uppercase px-3 py-1 rounded-full">Encrypted Channel</span>
                 </div>
                 {activeOrderChat.messages.map((m, i) => (
                   <div key={i} className={`flex flex-col ${m.sender === user.username ? 'items-end' : 'items-start'}`}>
                      <div className={`max-w-[85%] p-4 rounded-2xl font-medium text-sm shadow-sm ${m.sender === user.username ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-slate-800 rounded-tl-none border border-gray-100'}`}>
                        {m.text}
                      </div>
                      <span className="text-[10px] font-bold text-gray-400 mt-1 uppercase tracking-tighter px-1">{m.sender}</span>
                   </div>
                 ))}
                 {activeOrderChat.messages.length === 0 && <p className="text-center text-gray-400 font-bold mt-10">Start the conversation...</p>}
              </div>
              <form className="p-4 bg-white border-t border-gray-100 flex gap-3" onSubmit={(e) => {
                e.preventDefault();
                const msg = e.target.msg.value;
                if(!msg.trim()) return;
                sendMessage(activeOrderChat.id, msg);
                e.target.msg.value = '';
              }}>
                <input name="msg" className="flex-1 bg-gray-50 border border-gray-200 rounded-2xl px-5 py-3.5 focus:border-indigo-600 outline-none font-medium transition-all" placeholder="Type message..." />
                <Button type="submit" variant="dark" className="!p-3.5 rounded-2xl aspect-square"><Send size={20}/></Button>
              </form>
           </div>
        </div>
      )}
    </div>
  );
}
